# 利息/违约金计算器设计与算法逻辑文档

## 0. 组件架构

本功能已重构为独立的 Vue 3 组件，实现了逻辑与视图的分离，提高了复用性和可维护性。

- **路径**: `src/components/case/InterestCalculator.js`
- **通信机制**:
  - **Props**:
    - `visible`: 控制弹窗显隐。
    - `initialPrincipal`: 初始计算基数（通常为标的总额）。
  - **Emits**:
    - `update:visible`: 双向绑定关闭弹窗。
    - `apply`: 向父组件传递计算出的利息值。
- **依赖**: 依赖 `lprService.js` 获取最新的 LPR 数据和基准利率历史。

---

## 1. 概述

本模块旨在提供一个专业、灵活且合规的债务利息计算工具，支持**多种利率类型**、**自动分段计算**以及**历史利率回溯**。核心设计目标是满足法律实务中对“基准利率”与“LPR”自动衔接的复杂计算需求。

---

## 2. 利率类型体系

系统支持四种核心利率计算模式，优先级从高到低如下：

### 2.1 自定义利率 (Custom)

- **适用场景**：判决书或合同明确约定了固定数值的利率（如“年利率 24%”或“日万分之五”）。
- **参数**：
  - **数值**：用户输入（如 0.05）。
  - **单位**：百分之 (%)、千分之 (‰)、万分之 (‱)。
  - **时间基准**：年利率、月利率、日利率。
  - **计算时长**：
    1.  **日期范围**：指定起止日期（自动计算天数）。
    2.  **固定数量**：直接输入“10天”、“3个月”或“1.5年”。
- **算法**：系统内部统一将所有输入转换为 **年化利率** 和 **总天数** 进行计算。
  - **一年天数 (Year Basis)**：可选 360天 或 365天。
  - `日利率 = 年化利率 / Year Basis`

### 2.2 中国人民银行同期贷款基准利率与LPR自动分段 (Segmented - 推荐)

这是最复杂的模式，专门用于处理跨越 **2019年8月20日（LPR改革节点）** 的长期债务。

- **分段逻辑 (按日累加)**：
  - **2019年8月20日之前**：使用 **中国人民银行同期贷款基准利率**。
  - **2019年8月20日之后**：使用 **全国银行间同业拆借中心公布的LPR**。

- **详细配置**：
  1.  **基准利率部分 (Pre-2019)**：
      - **计算方式**：
        - **分段利率 (Dynamic)**：自动根据欠款日期查找当时有效的央行基准利率（如2015年10月24日调整后的利率）。
        - **指定利率 (Specified)**：用户强制指定使用某一个历史版本的基准利率（如“2012年7月6日版本”），或直接输入一个“自定义基准值”。
      - **基准档次**：6个月/1年/1-3年/3-5年/5年以上。
      - **利率调整**：支持在基准之上进行 **上浮/下浮 (%)** 或 **倍率 (x)**调整（如“基准利率上浮50%”或“基准利率的4倍”）。
  2.  **LPR部分 (Post-2019)**：
      - **LPR档次**：1年期 / 5年期。
      - **LPR浮动**：支持加点（bp）或倍率调整（算法：`(LPR + 基点) × 倍率` 或 `(LPR + 基点) ± 浮动%`）。

### 2.3 LPR 利率 (Pure LPR)

- **适用场景**：合同约定全程按照 LPR 计息，或债务发生在 2019年8月20日之后。
- **计算方式**：
  - **分段 LPR (Segmented)**：逐日查找当日有效的 LPR 利率（"随动"）。
  - **指定 LPR (Specified)**：全程使用某一日发布的 LPR 固定数值。
- **数据源**：直接调用数据库中存储的每月 20 日发布的 LPR 数据。

### 2.4 央行贷款基准利率 (Pure Benchmark)

- **适用场景**：旧案或特定合同约定全程固定使用央行基准利率，不转换为 LPR。
- **算法**：全程使用固定的基准利率数值（如 4.90%），或简化的分段逻辑（取起始日的基准利率）。

---

## 3. 核心算法逻辑：分段计算与四舍五入 (Segmented Calculation with Rounding)

为了解决“逐日累加”可能带来的微小精度误差，并符合法律财务计算的通行标准（即每一笔分段利息应独立计算并取整），本系统升级了核心算法。

### 3.1 算法流程

系统不再进行简单的逐日累加，而是先将整个时间跨度划分为若干个**利率不变的独立区间**（Segment），分别计算每个区间的利息，**四舍五入保留2位小数**后，再累加得到总利息。

**精度修正优势**：避免了 `10000 * 0.05%` 在浮点数运算中产生 `5.000000001` 并长期累积导致的误差，确保最终结果与银行/法院手工账单完全一致（精确到分）。

### 3.2 伪代码流程

```javascript
// 1. 识别所有利率变化的区间 (Identify Periods)
// 根据利率调整日（如LPR每月20日、央行基准调整日）将总时长切分为多个片段
let periods = identifyRateChangePeriods(startDate, endDate)
let totalInterest = 0

for (let period of periods) {
  // a. 获取该段及其适用利率
  let days = period.days
  let dailyRate = getApplicableDailyRate(period.startDate) // 获取该段有效的日利率

  // b. 计算该段原始利息
  let rawInterest = principal * dailyRate * days

  // c. ***关键步骤***：单段利息四舍五入 (Round to 2 decimals)
  let segmentInterest = Math.round(rawInterest * 100) / 100

  // d. 记录详单数据
  period.interest = segmentInterest

  // e. 累加总额
  totalInterest += segmentInterest
}

// f. 最终结果进一步取整（防御性）
return Math.round(totalInterest * 100) / 100
```

---

## 4. UI与交互特性 (UI/UX Features)

### 4.1 智能精度显示

为了提供更清爽的视觉体验，系统对利率数值进行了智能格式化：

- **去除无效零**：`3.80%` -> `3.8%`
- **限制小数位**：最多保留4位小数，避免出现 `3.85000001%` 这样的浮点数伪影。

### 4.2 清晰的详单展示

- **动态表头**：根据所选利率类型，详单表头动态显示为“LPR值”、“基准利率”或“年利率”。
- **表格化布局**：采用结构化表格展示每一段的起止日期、天数、执行利率及分段利息。

### 4.3 中文大写金额

在输入“计算基数”及展示“计算结果”时，系统会自动同步显示符合金融规范的中文大写金额（如“壹拾万零伍佰元整”），方便法律文书校对。

---

## 5. 数据架构与同步机制

为了保证数据的准确性和时效性，采用了 **云端 + 本地** 的双层架构。

### 4.1 数据来源

- **Tushare API** (`shibor_lpr`): 权威财经数据接口，提供每日/每月的 LPR 和 Shibor 数据。

### 4.2 存储方案

- **Supabase (`lpr_rates` 表)**: 持久化存储 LPR 历史数据。
  - 字段: `effective_date` (PK), `rate_1y`, `rate_5y`.
  - **RLS 策略**: 允许匿名用户 (`anon`) 读取和插入/更新数据 (用于前端自动同步)。

### 4.3 同步策略

1.  **自动检测**: 前端加载计算器时，会自动检查本地/数据库中最新的 LPR 日期。
2.  **过期判断**: 如果最新数据滞后于理论发布日（每月20日），且当前已过发布时间。
3.  **触发同步**: 系统后台自动调用 Tushare API 拉取最新数据，并 `upsert` 到 Supabase。
4.  **No-Code Update**: 确保用户在使用时始终获取最新利率。

---

## 6. 开发相关配置

- **环境变量**:
  - `VITE_TUSHARE_TOKEN`: Tushare API 访问令牌。
  - `VITE_SUPABASE_URL`: 数据库地址。
  - `VITE_SUPABASE_ANON_KEY`: 数据库访问密钥。
- **脚本工具**:
  - `scripts/sync-lpr-to-supabase.js`: 强制手动同步脚本 (用于初始化或紧急更新)。

---

## 7. 版本历史

| 版本 | 日期       | 变更内容                                                               |
| ---- | ---------- | ---------------------------------------------------------------------- |
| v1.0 | 2026-01-05 | 初始版本，实现核心计算功能                                             |
| v1.1 | 2026-01-06 | **重大升级**：算法改为分段四舍五入；UI全面优化（大写金额、表格化详单） |
