# 利息/违约金计算器设计与算法逻辑文档

## 0. 组件架构
本功能已重构为独立的 Vue 3 组件，实现了逻辑与视图的分离，提高了复用性和可维护性。

*   **路径**: `src/components/case/InterestCalculator.js`
*   **通信机制**:
    *   **Props**:
        *   `visible`: 控制弹窗显隐。
        *   `initialPrincipal`: 初始计算基数（通常为标的总额）。
    *   **Emits**:
        *   `update:visible`: 双向绑定关闭弹窗。
        *   `apply`: 向父组件传递计算出的利息值。
*   **依赖**: 依赖 `lprService.js` 获取最新的 LPR 数据和基准利率历史。

---

## 1. 概述
本模块旨在提供一个专业、灵活且合规的债务利息计算工具，支持**多种利率类型**、**自动分段计算**以及**历史利率回溯**。核心设计目标是满足法律实务中对“基准利率”与“LPR”自动衔接的复杂计算需求。

---

## 2. 利率类型体系
系统支持四种核心利率计算模式，优先级从高到低如下：

### 2.1 自定义利率 (Custom)
*   **适用场景**：判决书或合同明确约定了固定数值的利率（如“年利率 24%”或“日万分之五”）。
*   **参数**：
    *   **数值**：用户输入（如 0.05）。
    *   **单位**：百分之 (%)、千分之 (‰)、万分之 (‱)。
    *   **时间基准**：年利率、月利率、日利率。
    *   **计算时长**：
        1.  **日期范围**：指定起止日期（自动计算天数）。
        2.  **固定数量**：直接输入“10天”、“3个月”或“1.5年”。
*   **算法**：系统内部统一将所有输入转换为 **年化利率** 和 **总天数** 进行计算。
    *   **一年天数 (Year Basis)**：可选 360天 或 365天。
    *   `日利率 = 年化利率 / Year Basis`

### 2.2 中国人民银行同期贷款基准利率与LPR自动分段 (Segmented - 推荐)
这是最复杂的模式，专门用于处理跨越 **2019年8月20日（LPR改革节点）** 的长期债务。

*   **分段逻辑 (按日累加)**：
    *   **2019年8月20日之前**：使用 **中国人民银行同期贷款基准利率**。
    *   **2019年8月20日之后**：使用 **全国银行间同业拆借中心公布的LPR**。

*   **详细配置**：
    1.  **基准利率部分 (Pre-2019)**：
        *   **计算方式**：
            *   **分段利率 (Dynamic)**：自动根据欠款日期查找当时有效的央行基准利率（如2015年10月24日调整后的利率）。
            *   **指定利率 (Specified)**：用户强制指定使用某一个历史版本的基准利率（如“2012年7月6日版本”），或直接输入一个“自定义基准值”。
        *   **基准档次**：6个月/1年/1-3年/3-5年/5年以上。
        *   **利率调整**：支持在基准之上进行 **上浮/下浮 (%)** 或 **倍率 (x)**调整（如“基准利率上浮50%”或“基准利率的4倍”）。
    2.  **LPR部分 (Post-2019)**：
        *   **LPR档次**：1年期 / 5年期。
        *   **LPR浮动**：支持加点（bp）或倍率调整（算法：`(LPR + 基点) × 倍率` 或 `(LPR + 基点) ± 浮动%`）。

### 2.3 LPR 利率 (Pure LPR)
*   **适用场景**：合同约定全程按照 LPR 计息，或债务发生在 2019年8月20日之后。
*   **计算方式**：
    *   **分段 LPR (Segmented)**：逐日查找当日有效的 LPR 利率（"随动"）。
    *   **指定 LPR (Specified)**：全程使用某一日发布的 LPR 固定数值。
*   **数据源**：直接调用数据库中存储的每月 20 日发布的 LPR 数据。

### 2.4 央行贷款基准利率 (Pure Benchmark)
*   **适用场景**：旧案或特定合同约定全程固定使用央行基准利率，不转换为 LPR。
*   **算法**：全程使用固定的基准利率数值（如 4.90%），或简化的分段逻辑（取起始日的基准利率）。

---

## 3. 核心算法逻辑：逐日累加法 (Day-by-Day Accumulation)

为了确保跨周期、利率变动时的计算精度，本系统对于“分段模式”采用 **逐日循环累加** 的算法，而非简单的“本金 x 利率 x 天数”。

### 3.1 日期边界处理 (Date Boundary)
支持用户自定义“算头算尾”规则，影响总天数 `days` 的计算：
*   **算头算尾 (Both)**: `end - start + 1`
*   **算头不算尾 (Start Only)**: `end - start` (默认逻辑)
*   **算尾不算头 (End Only)**: `end - start`
*   **两头都不算 (Neither)**: `end - start - 1`

### 3.2 伪代码流程
```javascript
let totalInterest = 0;
let currentDate = startDate;

// 循环直到结束日期
while (currentDate <= endDate) {
    let dailyRate = 0;

    // 1. 判断当前日期处于哪个政策区间
    if (useBenchmarkLogic(currentDate)) {
        // === 区间 A: 基准利率时代 ===
        
        // a. 获取基础值
        let baseRate = 0;
        if (method === 'segmented') {
            baseRate = findHistoricalBenchmark(currentDate); // 查找当日有效的央行利率
        } else {
            baseRate = specifiedBenchmarkRate; // 用户指定的固定历史版本
        }

        // b. 应用调整 (上浮/下浮/倍数)
        dailyRate = applyAdjustment(baseRate, adjustmentConfig) / yearBasis;

    } else {
        // === 区间 B: LPR时代 ===
        
        // a. 获取基础值
        // 查找当日有效的LPR (通常每月20日更新，未更新则沿用上月)
        let lprRecord = findLPRRecord(currentDate); 
        let lprValue = lprRecord[tier];

        // b. 应用调整 (先加减BP，再乘除倍率)
        // Rate = ((LPR + BP) * Multiplier)
        let adjustedLpr = applyBPAndMultiplier(lprValue, bpConfig, floatConfig);
        dailyRate = adjustedLpr / yearBasis;
    }

    // 2. 期间记录 (用于生成详单)
    if (currentPeriod.type !== currentType) {
        savePeriod(currentPeriod);
        startNewPeriod(currentDate, currentType);
    }

    // 3. 累加当日利息
    totalInterest += principal * dailyRate;
    currentPeriod.interest += principal * dailyRate;

    // 4. 进入下一天
    currentDate = currentDate + 1 day;
}

return totalInterest;
```

---

## 4. 数据架构与同步机制

为了保证数据的准确性和时效性，采用了 **云端 + 本地** 的双层架构。

### 4.1 数据来源
*   **Tushare API** (`shibor_lpr`): 权威财经数据接口，提供每日/每月的 LPR 和 Shibor 数据。

### 4.2 存储方案
*   **Supabase (`lpr_rates` 表)**: 持久化存储 LPR 历史数据。
    *   字段: `effective_date` (PK), `rate_1y`, `rate_5y`.
    *   **RLS 策略**: 允许匿名用户 (`anon`) 读取和插入/更新数据 (用于前端自动同步)。

### 4.3 同步策略
1.  **自动检测**: 前端加载计算器时，会自动检查本地/数据库中最新的 LPR 日期。
2.  **过期判断**: 如果最新数据滞后于理论发布日（每月20日），且当前已过发布时间。
3.  **触发同步**: 系统后台自动调用 Tushare API 拉取最新数据，并 `upsert` 到 Supabase。
4.  **No-Code Update**: 确保用户在使用时始终获取最新利率。

---

## 5. 开发相关配置
*   **环境变量**:
    *   `VITE_TUSHARE_TOKEN`: Tushare API 访问令牌。
    *   `VITE_SUPABASE_URL`: 数据库地址。
    *   `VITE_SUPABASE_ANON_KEY`: 数据库访问密钥。
*   **脚本工具**:
    *   `scripts/sync-lpr-to-supabase.js`: 强制手动同步脚本 (用于初始化或紧急更新)。
