# 要素式文书功能实施方案 (终极详细版)

## 1. 背景与目标

为了提升法律文书起草效率，降低用户书写门槛，本项目将新增“要素式文书”功能。初期以**“买卖合同纠纷民事起诉状”**为切入点，支持用户通过结构化表单输入案情要素，系统自动生成规范文书，并提供在线预览与 Word 导出功能。

## 2. 总体架构

本功能将作为一个独立的业务模块实现，采用 **Feature-Based** 架构组织代码，位于 `src/features/document` 目录下。

### 核心流程

1.  **数据采集**: 用户在前端填写结构化表单。
2.  **数据组装**: 前端将表单数据转换为标准 JSON 模型。
3.  **文档生成**: (Mock阶段) 前端根据 JSON 拼接生成 Word/HTML; (正式阶段) 发送 JSON 至后端，后端生成 `.docx` 文件流。
4.  **在线预览**: 将生成的文档 URL 或 Blob 传递给 **OnlyOffice Document Server** 进行预览。

## 3. 详细设计

### 3.1 目录结构

```bash
src/features/document/
├── components/
│   ├── OnlyOfficePreview.vue       # OnlyOffice 预览通用组件
│   ├── sales-contract/             # 买卖合同纠纷专用组件
│   │   ├── PartyInfoPanel.vue      #当事人信息板块
│   │   ├── ClaimRequestPanel.vue   # 诉讼请求板块
│   │   ├── FactReasonPanel.vue     # 事实与理由板块
│   │   └── DisputeResolution.vue   # 纠纷解决意愿板块
├── services/
│   ├── docService.js               # 文书 API 服务 (Preview/Export)
│   └── docMockData.js              # Mock 数据与生成逻辑
├── views/
│   ├── StructuredDocList.vue       # 文书列表入口
│   └── SalesContractComplaint.vue  # 买卖合同纠纷主填报页
└── router.js                       # 独立的路由定义
```

### 3.2 路由系统的集成

在 `src/router/modules/document.js` 中定义：

```javascript
export default [
  {
    path: '/document/structured',
    name: 'StructuredDocList',
    component: () => import('@/features/document/views/StructuredDocList.vue'),
    meta: { title: '要素式文书列表' }
  },
  {
    path: '/document/structured/sales-contract',
    name: 'SalesContractComplaint',
    component: () => import('@/features/document/views/SalesContractComplaint.vue'),
    meta: { title: '买卖合同纠纷起诉状' }
  }
]
```

### 3.3 数据字典与字段定义

本节详细定义表单中每一个输入项的字段名、类型与校验规则。

#### 3.3.1 当事人信息 (PartyInfoPanel)

- **数据结构**: `plaintiffs` (原告数组), `defendants` (被告数组), `thirdParties` (第三人数组)
- **单体对象字段**:

| 字段名 (`v-model`) | 类型   | 说明              | 校验规则                                                  | 备注               |
| :----------------- | :----- | :---------------- | :-------------------------------------------------------- | :----------------- |
| `type`             | String | 主体类型          | 必填, 枚举: `'natural'` (自然人), `'legal'` (法人/非法人) | 默认 'natural'     |
| `name`             | String | 姓名/名称         | 必填                                                      |                    |
| `gender`           | String | 性别              | 当 type='natural' 时选填, 枚举: `'male'`, `'female'`      |                    |
| `birthDate`        | Date   | 出生日期          | 当 type='natural' 时选填                                  |                    |
| `nation`           | String | 民族              | 当 type='natural' 时选填                                  |                    |
| `idCard`           | String | 身份证号/统信代码 | 选填                                                      | 需根据类型验证格式 |
| `address`          | String | 住所地/注册地     | 必填                                                      |                    |
| `workUnit`         | String | 工作单位          | 当 type='natural' 时选填                                  |                    |
| `position`         | String | 职务              | 选填                                                      |                    |
| `contact`          | String | 联系电话          | 必填                                                      | 手机号格式验证     |
| `legalRep`         | String | 法定代表人        | 当 type='legal' 时必填                                    |                    |
| `legalRepPosition` | String | 法定代表人职务    | 当 type='legal' 时选填                                    |                    |
| `orgType`          | String | 组织类型          | 当 type='legal' 时选填, 枚举: `'limited'`, `'joint'`, ... |

#### 3.3.2 诉讼请求 (ClaimRequestPanel)

对应文档的 "诉讼请求" 章节，字段前缀 `req_`。

| 字段名                     | 类型    | 说明           | 交互逻辑                                    |
| :------------------------- | :------ | :------------- | :------------------------------------------ |
| `req_paymentAmount`        | Number  | 给付价款金额   | 必填，精度2位小数                           |
| `req_interest_enabled`     | Boolean | 是否主张利息   | 勾选后展开下方利息详情                      |
| `req_interest_endDate`     | Date    | 截止日期       |                                             |
| `req_interest_total`       | Number  | 暂计利息总额   |                                             |
| `req_interest_base`        | Number  | 计算基数       | 默认填入 `req_paymentAmount`                |
| `req_interest_rateType`    | String  | 利率标准       | 枚举: `'LPR'`, `'LPR_4X'`, `'FIXED'`        |
| `req_compensation_enabled` | Boolean | 是否主张赔偿金 | 勾选后展开                                  |
| `req_compensation_amount`  | Number  | 赔偿金额       |                                             |
| `req_contract_action`      | String  | 合同处理动作   | 枚举: `'continue'`, `'terminate'`, `'none'` |
| `req_legalCost`            | Boolean | 承担诉讼费     | 默认 `true`                                 |

#### 3.3.3 事实与理由 (FactReasonPanel)

对应文档 "事实与理由" 章节，字段前缀 `fact_`。

**1. 合同签订**
| 字段名 | 类型/控件 | 说明 |
| :--- | :--- | :--- |
| `fact_contractName` | Input | 合同名称 |
| `fact_signDate` | DatePicker | 签订时间 |
| `fact_signPlace` | Input | 签订地点 |
| `fact_noWrittenContract`| Checkbox | 无书面合同 |

**2. 标的物**
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `fact_items` | Array | 动态数组: `[{ name, spec, quantity, price }]` |
| `fact_totalPrice` | Number | 总价款 (自动计算建议) |
| `fact_paymentMethod` | Select | 支付方式 (现金/转账/票据) |

**3. 违约情形**
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `fact_breachType` | CheckboxGroup | 违约类型: `[逾期付款, 逾期交货, 质量问题...]` |
| `fact_overdueDays` | Number | 逾期天数 |
| `fact_remindDate` | DatePicker | 催告时间 |

_(注：此处仅列举核心字段，实际开发中将覆盖文档中的全部24项要素)_

### 3.4 API 接口定义 (JSON Payload)

#### 3.4.1 提交预览/生成接口

**Endpoint**: `POST /api/v1/document/structure/preview`
**Request Body**:

```json
{
  "docType": "sales_contract_complaint",
  "data": {
    "plaintiffs": [
      {
        "type": "natural",
        "name": "张三",
        "gender": "male",
        "address": "北京市朝阳区...",
        "contact": "13800138000"
      }
    ],
    "defendants": [...],
    "claims": {
      "paymentAmount": 50000.00,
      "interest": {
        "enabled": true,
        "base": 50000.00,
        "rateType": "LPR",
        "startDate": "2023-01-01"
      },
      "legalCost": true
    },
    "facts": {
      "hasContract": true,
      "contractName": "设备采购合同",
      "signDate": "2022-12-01",
      "items": [
        { "name": "服务器", "spec": "R740", "count": 10 }
      ]
    }
  }
}
```

**Response (Mock)**:

```json
{
  "code": 200,
  "data": {
    "previewUrl": "http://127.0.0.1:5173/mock_docs/generated_preview_123.docx",
    "onlyOfficeConfig": {
      "document": {
        "fileType": "docx",
        "key": "unique_key_123",
        "title": "起诉状_张三.docx",
        "url": "http://127.0.0.1:5173/mock_docs/generated_preview_123.docx"
      },
      "editorConfig": { "mode": "view" }
    }
  }
}
```

### 3.5 OnlyOffice 集成方案细节

#### 3.5.1 组件封装 (`OnlyOfficePreview.vue`)

此组件负责加载 OnlyOffice 的 iframe。

```vue
<template>
  <div id="onlyoffice-container" style="height: 600px;"></div>
</template>

<script setup>
import { onMounted, onUnmounted } from 'vue'

const props = defineProps({
  config: Object,
  apiUrl: {
    type: String,
    default: 'https://documentserver.example.com/web-apps/apps/api/documents/api.js'
  }
})

let docEditor = null

onMounted(() => {
  // 1. 动态加载 API 脚本 (如果尚未加载)
  if (!window.DocsAPI) {
    const script = document.createElement('script')
    script.src = props.apiUrl
    script.onload = initEditor
    document.head.appendChild(script)
  } else {
    initEditor()
  }
})

function initEditor() {
  // 2. 初始化编辑器
  docEditor = new window.DocsAPI.DocEditor('onlyoffice-container', props.config)
}

onUnmounted(() => {
  if (docEditor) {
    docEditor.destroyEditor()
  }
})
</script>
```

## 4. 开发里程碑 (Checklist)

### Phase 1: 框架搭建

- [ ] 创建 `src/features/document` 目录结构
- [ ] 配置 `src/router/modules/document.js` 路由
- [ ] 创建空壳页面 `StructuredDocList.vue` 和 `SalesContractComplaint.vue`

### Phase 2: 核心表单开发

- [ ] 实现 `PartyInfoPanel`：支持多原告/被告添加，字段校验
- [ ] 实现 `ClaimRequestPanel`：完成金额输入与利息计算逻辑联动
- [ ] 实现 `FactReasonPanel`：完成25项要素的布局与输入
- [ ] 状态管理：在父组件聚合所有子组件数据

### Phase 3: 预览集成

- [ ] 开发 `OnlyOfficePreview.vue` 组件
- [ ] 实现 `docService.preview` Mock 逻辑 (返回静态 docx 配置)
- [ ] 联调：点击预览 -> 组装 JSON -> 调用 Mock -> 弹窗显示 OnlyOffice

### Phase 4: 导出与优化

- [ ] 实现前端简单的 Word 导出 (使用 json-to-word 库或 Mock Blob)
- [ ] UI 样式精修 (对齐文档风格)
- [ ] 全面的表单验证测试
