# 迟延履行利息计算器设计与算法逻辑文档

## 0. 组件架构

本功能是一个独立的 Vue 3 组件，用于计算法院判决生效后的迟延履行利息。

- **路径**: `src/components/case/DelayedInterestCalculator.js`
- **通信机制**:
  - **Props**:
    - `visible`: 控制弹窗显隐（Boolean）。
    - `initialPrincipal`: 初始计算基数，通常为判决确定的债务本金（Number）。
  - **Emits**:
    - `update:visible`: 双向绑定关闭弹窗。
    - `apply`: 向父组件传递计算结果对象 `{ generalInterest, doubleInterest, totalInterest }`。
- **依赖**:
  - `lprService.js`: 获取 LPR 数据和央行基准利率历史。
  - `SmartDatePicker.js`: 智能日期选择器组件。

---

## 1. 概述

### 1.1 功能定位

迟延履行利息计算器是专门针对法院执行程序中计算被执行人迟延履行期间债务利息的工具。其法律依据为：

> **《最高人民法院关于执行程序中计算迟延履行期间的债务利息适用法律若干问题的解释》**（法释〔2014〕8号）

### 1.2 核心公式

```
迟延履行期间的债务利息 = 一般债务利息 + 加倍部分债务利息
```

其中：

- **一般债务利息**：生效法律文书确定的金钱债务应支付的利息
- **加倍部分债务利息**：债务本金 × 日万分之一点七五 × 迟延履行期间

---

## 2. 功能模块详解

### 2.1 基础参数输入

| 参数     | 类型   | 说明                               |
| -------- | ------ | ---------------------------------- |
| 计算基数 | Number | 债务本金金额（元）                 |
| 起始日期 | String | 迟延履行期间开始日期（YYYY-MM-DD） |
| 截止日期 | String | 迟延履行期间结束日期（YYYY-MM-DD） |
| 一年天数 | Number | 360 或 365（默认360）              |

**日期计算规则**：起止日期均计算在内。例如：2026-01-04 至 2026-01-05 计算为 **2天**。

```javascript
// 天数计算公式
const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1
```

### 2.2 一般债务利息配置

#### 2.2.1 开关控制

通过开关控制是否计算一般债务利息：

- **关闭状态**：仅计算加倍部分债务利息
- **开启状态**：显示详细利率配置选项

#### 2.2.2 利率类型选项

| 类型                  | 说明                              | 适用场景                  |
| --------------------- | --------------------------------- | ------------------------- |
| **固定利率**          | 用户直接输入年利率百分比          | 判决书明确约定固定利率    |
| **基准利率与LPR分段** | 2019-08-20前用基准利率，之后用LPR | 跨越LPR改革节点的长期债务 |
| **LPR**               | 全程使用贷款市场报价利率          | 2019年8月后的债务         |
| **基准利率**          | 全程使用央行贷款基准利率          | 2019年8月前的旧案         |

#### 2.2.3 利率调整方式

所有利率类型均支持以下调整方式：

| 调整类型 | 公式                  | 示例            |
| -------- | --------------------- | --------------- |
| 无       | `rate`                | 直接使用原利率  |
| 上浮     | `rate × (1 + value%)` | 基准利率上浮50% |
| 下浮     | `rate × (1 - value%)` | LPR下浮10%      |
| 倍率     | `rate × value`        | 基准利率的4倍   |

### 2.3 加倍部分债务利息

根据司法解释，加倍部分债务利息采用**固定日利率**：

```javascript
const doubleRateDaily = 0.000175 // 日万分之一点七五
const doubleInterest = principal * doubleRateDaily * days
```

此部分不受一般债务利息开关影响，始终计算。

---

## 3. 核心算法逻辑

### 3.1 固定利率计算

```javascript
// 年利率 = 用户输入 × 调整系数
const baseRate = fixedRate / 100
const annualRate = applyAdjustment(baseRate, adjustType, adjustValue)

// 利息 = 本金 × 年利率 × 天数 ÷ 一年天数
const interest = (principal * annualRate * days) / yearBasis
```

### 3.2 LPR分段计算（分段四舍五入法）

系统核心算法已升级为“分段独立取整”，以消除浮点数累积误差：

```javascript
let totalInterest = 0
// 1. 根据利率变化点识别所有区间
let periods = identifyRateChangePeriods(startDate, endDate)

for (let period of periods) {
  // 2. 计算区间原始利息
  // 利息 = 本金 × (年利率 ÷ 360) × 天数
  let rawInterest = principal * (period.rate / yearBasis) * period.days

  // 3. ***四舍五入保留2位小数***
  let segmentInterest = Math.round(rawInterest * 100) / 100

  // 4. 累加
  totalInterest += segmentInterest

  // 5. 记录详单
  period.interest = segmentInterest
}
return totalInterest // 最终结果通常无需再次取整，因为每段已取整
```

### 3.3 基准利率与LPR自动分段

逻辑同上，仅利率获取源不同：

```javascript
for (let p of periods) {
  let rate = 0
  if (p.startDate < '2019-08-20') {
    rate = getBenchmarkRate(p.startDate) // 央行基准
  } else {
    rate = getLprRate(p.startDate) // LPR
  }
  // ... 计算 rawInterest 并四舍五入 ...
}
```

---

## 4. 数据结构

### 4.1 计算器状态 (calculator)

```javascript
{
    // 基础参数
    principal: 0,           // 计算基数
    startDate: '',          // 起始日期
    endDate: '',            // 截止日期
    yearBasis: 360,         // 一年天数

    // 一般债务利息配置
    enableGeneralInterest: false,  // 是否开启
    rateType: 'fixed',             // 利率类型

    // 固定利率选项
    fixedRate: 0,
    fixedAdjustType: 'none',
    fixedAdjustValue: 0,

    // LPR选项
    lprTier: '1y',          // '1y' | '5y'
    lprAdjustType: 'none',
    lprAdjustValue: 0,

    // 基准利率选项
    benchmarkTier: '6m',    // '6m' | '1y' | '1y-3y' | '3y-5y' | 'over5y'
    benchmarkAdjustType: 'none',
    benchmarkAdjustValue: 0,

    // 计算结果
    result: null
}
```

### 4.2 计算结果 (result)

```javascript
{
    days: 30,                    // 迟延履行天数
    startDate: '2026-01-01',
    endDate: '2026-01-30',
    principal: 100000,
    yearBasis: 360,

    // 利息结果
    generalInterest: 1500.00,    // 一般债务利息
    doubleInterest: 525.00,      // 加倍部分债务利息
    totalInterest: 2025.00,      // 合计

    // 描述信息
    generalRateDesc: '3.50%',
    doubleRateDesc: '日万分之一点七五',

    // 详单数据
    generalPeriods: [...],       // 一般债务利息分段详单
    doubleDetail: {              // 加倍部分债务利息详单
        startDate, endDate, days, dailyRate, interest, formula
    }
}
```

### 4.3 分段详单 (period)

```javascript
{
    type: 'lpr',                 // 'fixed' | 'lpr' | 'benchmark'
    typeLabel: 'LPR',
    startDate: '2026-01-01',
    endDate: '2026-01-30',
    days: 30,
    baseRate: '3.50%',           // 基础利率
    adjustmentDesc: '上浮10%',   // 调整描述
    adjustedRate: '3.85%',       // 调整后利率
    interest: 320.83,            // 本段利息
    formula: '= 100,000 × (3.85% ÷ 360) × 30'
}
```

---

## 5. 功能特性

### 5.1 中文大写金额转换

组件内置 `toChineseCurrency()` 方法，将数字金额转换为中文大写：

```javascript
toChineseCurrency(739.5) // => "柒佰叁拾玖元伍角"
toChineseCurrency(1044) // => "壹仟零肆拾肆元整"
```

### 5.2 计算详单导出

点击"下载详单"按钮，生成格式化的HTML报告，支持：

- **打印为PDF**：通过浏览器打印功能（Ctrl+P）
- **导出为Word**：HTML文件可直接用Word打开

报告内容包括：

- 基础信息（计算基数、起止日期、天数）
- 计算结果（含中文大写）
- 一般债务利息详单（表格）
- 加倍部分债务利息详单（表格）
- 法律依据说明

---

## 6. 使用说明

### 6.1 组件引入

```javascript
// 在父组件中引入
import DelayedInterestCalculator from '../../components/case/DelayedInterestCalculator.js'

export default {
  components: {
    DelayedInterestCalculator
  },
  data() {
    return {
      showCalculator: false,
      claimAmount: 580000
    }
  },
  methods: {
    handleApply(result) {
      // result = { generalInterest, doubleInterest, totalInterest }
      console.log('计算结果:', result)
    }
  }
}
```

### 6.2 模板使用

```html
<DelayedInterestCalculator
  :visible="showCalculator"
  :initial-principal="claimAmount"
  @update:visible="showCalculator = $event"
  @apply="handleApply"
/>
```

---

## 7. 法律依据

### 7.1 主要法规

1. **《最高人民法院关于执行程序中计算迟延履行期间的债务利息适用法律若干问题的解释》**（法释〔2014〕8号）
2. **《中华人民共和国民事诉讼法》第二百六十条**

### 7.2 关键条款摘录

> **第一条** 根据民事诉讼法第二百五十三条规定加倍计算之后的迟延履行期间的债务利息，包括迟延履行期间的一般债务利息和加倍部分债务利息。
>
> 迟延履行期间的一般债务利息，根据生效法律文书确定的方法计算；生效法律文书未确定给付该利息的，不予计算。
>
> 加倍部分债务利息的计算方法为：加倍部分债务利息＝债务人尚未清偿的生效法律文书确定的除一般债务利息之外的金钱债务×日万分之一点七五×迟延履行期间。

---

## 8. 维护指南

### 8.1 相关文件

| 文件路径                                           | 说明                     |
| -------------------------------------------------- | ------------------------ |
| `src/components/case/DelayedInterestCalculator.js` | 主组件文件               |
| `src/views/case/CaseFinancials.js`                 | 引用该组件的财务信息页面 |
| `src/services/lprService.js`                       | LPR和基准利率数据服务    |
| `src/components/common/SmartDatePicker.js`         | 日期选择器组件           |

### 8.2 常见修改场景

#### 修改加倍部分利率

如果法律规定调整了加倍部分的日利率，修改此处：

```javascript
// src/components/case/DelayedInterestCalculator.js
const doubleRateDaily = 0.000175 // 修改此值
```

#### 添加新的利率类型

1. 在 `rateTypeOptions` 计算属性中添加新选项
2. 在 `calculateInterest()` 的 `switch` 语句中添加对应分支
3. 创建对应的计算方法（如需分段，参考 `calculateLprInterestWithDetails`）

#### 修改导出报告样式

修改 `downloadReport()` 方法中的 HTML 模板即可。

### 8.3 测试用例

| 场景       | 输入                      | 预期结果                                            |
| ---------- | ------------------------- | --------------------------------------------------- |
| 仅加倍利息 | 本金100万，30天           | 加倍利息 = 1,000,000 × 0.000175 × 30 = 5,250元      |
| 固定利率   | 本金100万，30天，年利率5% | 一般利息 = 1,000,000 × 0.05 ÷ 360 × 30 = 4,166.67元 |
| 同日计算   | 起止日期相同              | 天数 = 1天                                          |
| 跨日计算   | 01-04至01-05              | 天数 = 2天                                          |

---

## 9. 版本历史

| 版本 | 日期       | 变更内容                                                                                      |
| ---- | ---------- | --------------------------------------------------------------------------------------------- |
| v1.0 | 2026-01-05 | 初始版本，实现核心计算功能                                                                    |
| v1.1 | 2026-01-05 | 添加计算详单、中文大写、导出PDF功能                                                           |
| v1.2 | 2026-01-05 | 修复日期计算（起止日期均计入）、添加"应用到标的"按钮                                          |
| v1.3 | 2026-01-06 | **核心升级**：算法由逐日累加改为分段四舍五入；UI优化（表头动态化、LPR清爽显示、去除冗余标签） |

---

## 10. 联系方式

如有问题或建议，请联系开发团队：**Alpha&Leader Legal Tech**
