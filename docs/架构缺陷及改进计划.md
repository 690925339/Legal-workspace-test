# æ¶æ„å®¡æŸ¥ä¸ç¼ºé™·æ”¹è¿›è®¡åˆ’

> **æ–‡æ¡£çŠ¶æ€**: **å®æ–½ä¸­** âœ…
> **åˆ›å»ºæ—¥æœŸ**: 2026-01-04
> **æœ€åæ›´æ–°**: 2026-01-04
> **å®¡æŸ¥å¯¹è±¡**: Legal Workspace v3 (Frontend)
> **æ–‡æ¡£ç‰ˆæœ¬**: v2.1 (å¾®æœåŠ¡å¯¹é½ç‰ˆ)
> **å…³è”æ–‡æ¡£**: [å¾®æœåŠ¡æ²»ç†æ–‡æ¡£](./å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md) | [æ¶æ„è®¾è®¡æ–‡æ¡£](./æ¶æ„è®¾è®¡æ–‡æ¡£.md)
>
> **æœ€æ–°è¿›å±•** (2026-01-04):
>
> - `CaseDetail.js` å·²ä¼˜åŒ–ï¼Œä» 1451 è¡Œç²¾ç®€è‡³ ~150 è¡Œï¼Œç§»é™¤é‡å¤ä»£ç  90%
> - ç›®æ ‡ç»“æ„å‡çº§ä¸º v2ï¼Œæ–°å¢ `shared/`, `layouts/`, `router/` åˆ†å±‚è®¾è®¡
> - **DDD é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„**ï¼šfeatures ç›®å½•ä¸åç«¯å¾®æœåŠ¡é¢†åŸŸå¯¹åº”
> - **å¾®æœåŠ¡é€‚é…è§„åˆ’**ï¼šService å±‚åŒæ¨¡å¼è®¾è®¡ï¼Œæ”¯æŒ Supabase / BFF åˆ‡æ¢
> - **AI æµå¼å®¢æˆ·ç«¯**ï¼šaiService æ”¯æŒ SSE è§£æã€å–æ¶ˆæ“ä½œ
> - **æ€§èƒ½ä¼˜åŒ–**ï¼šBatchLoader è§£å†³ N+1 é—®é¢˜ï¼Œè¯·æ±‚ç¼“å­˜

## å®æ–½è¿›åº¦æ‘˜è¦

### å‰ç«¯æ¶æ„ç°ä»£åŒ–

| é˜¶æ®µ                   | çŠ¶æ€          | è¯´æ˜                                          |
| :--------------------- | :------------ | :-------------------------------------------- |
| **Phase 1: åŸºç¡€è®¾æ–½**  | âœ… å·²å®Œæˆ     | ç›®å½•ç»“æ„ã€è·¯å¾„åˆ«åã€API Client                |
| **Phase 2: Auth è¯•ç‚¹** | âœ… å·²å®Œæˆ     | Pinia å®‰è£…ã€Auth Store åˆ›å»º                   |
| **Phase 3: Case æ ¸å¿ƒ** | âœ… å·²å®Œæˆ     | Service Layerã€Composables                    |
| **Phase 4: å…¶ä»–é¢†åŸŸ**  | âœ… å·²å®Œæˆ     | legal-researchã€contractã€documentã€system    |
| **ä»£ç ä¼˜åŒ–**           | âœ… **å·²å®Œæˆ** | CaseDetail.js ç²¾ç®€ï¼ˆ1451 â†’ 150 è¡Œï¼Œå‡å°‘ 90%ï¼‰ |
| **æ¶æ„è®¾è®¡ä¼˜åŒ–**       | âœ… **å·²å®Œæˆ** | ç›®æ ‡ç»“æ„ v2ã€DDD å¯¹é½ã€æµ‹è¯•ç­–ç•¥ã€å›æ»šæ–¹æ¡ˆ     |
| **ç»„ä»¶è¿ç§»**           | ğŸ”„ è¿›è¡Œä¸­     | é€æ­¥å°† .js è½¬ä¸º .vue SFCï¼ˆè¿ç§»æˆæœ¬å·²é™ä½ï¼‰    |
| **ç›®å½•è¿ç§»**           | ğŸ”„ å¾…å¼€å§‹     | å»ºç«‹ shared/layouts/features æ–°ç»“æ„           |

### å¾®æœåŠ¡é€‚é…å‡†å¤‡ (å¯¹é½ `å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md`)

| é˜¶æ®µ                  | çŠ¶æ€          | è¯´æ˜                               |
| :-------------------- | :------------ | :--------------------------------- |
| **API Client å¢å¼º**   | âœ… **å·²è§„åˆ’** | JWT æ³¨å…¥ã€SSE æµå¼ã€è¯·æ±‚å–æ¶ˆã€ç¼“å­˜ |
| **AI Service å®¢æˆ·ç«¯** | âœ… **å·²è§„åˆ’** | SSE è§£æã€æµå¼å“åº”ã€å–æ¶ˆæ“ä½œ       |
| **Service åŒæ¨¡å¼**    | âœ… **å·²è§„åˆ’** | æ”¯æŒ Supabase / BFF ç¯å¢ƒå˜é‡åˆ‡æ¢   |
| **BatchLoader**       | âœ… **å·²è§„åˆ’** | N+1 é—®é¢˜è§£å†³æ–¹æ¡ˆ                   |
| **BFF å¯¹æ¥**          | ğŸ“… å¾…åç«¯     | ç­‰å¾…åç«¯ Phase 1 ä¸Šçº¿ååˆ‡æ¢        |

## 1. æ¦‚è§ˆ

æœ¬æ¬¡æ¶æ„å®¡æŸ¥é’ˆå¯¹ `legal-workspace-vue` é¡¹ç›®çš„å½“å‰ä»£ç å®ç°ä¸ `æ¶æ„è®¾è®¡æ–‡æ¡£.md` è¿›è¡Œå¯¹æ¯”ï¼Œå‘ç°äº†ä¸€äº›å…³é”®çš„æ¶æ„åç¦»å’ŒæŠ€æœ¯å€ºåŠ¡ã€‚æœ¬æ–‡æ¡£æ—¨åœ¨è®°å½•è¿™äº›ç¼ºé™·ï¼Œå¹¶åˆ¶å®šç›¸åº”çš„æ”¹è¿›è®¡åˆ’ï¼Œä»¥ç¡®ä¿é¡¹ç›®çš„é•¿æœŸå¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

## 2. æ ¸å¿ƒæ¶æ„ç¼ºé™·

### 2.1 è·¯ç”±ç³»ç»Ÿå®ç°åç¦» (High Severity)

- **ç°çŠ¶**: é¡¹ç›®ä¾èµ–ä¸­å·²å®‰è£… `vue-router`ï¼Œä½†åœ¨ `src/router.js` ä¸­å´æ‰‹åŠ¨å®ç°äº†ä¸€ä¸ªåŸºäº `window.location.hash` å’Œ `hashchange` äº‹ä»¶çš„ç®€æ˜“è·¯ç”±ç³»ç»Ÿã€‚
- **é—®é¢˜**:
  - "é‡æ–°é€ è½®å­"ï¼Œå¢åŠ äº†ç»´æŠ¤æˆæœ¬ã€‚
  - ç¼ºä¹ `vue-router` æä¾›çš„æ ‡å‡†åŠŸèƒ½ï¼ˆå¦‚åµŒå¥—è·¯ç”±ã€è·¯ç”±å®ˆå«ã€æ‡’åŠ è½½ã€æ»šåŠ¨è¡Œä¸ºç­‰ï¼‰ã€‚
  - ä¸æ¶æ„æ–‡æ¡£ä¸­æè¿°çš„ "è·¯ç”±å®ˆå«é›†æˆ" å­˜åœ¨å®ç°ä¸Šçš„å·®è·ï¼ˆç›®å‰æ˜¯ç¡¬ç¼–ç çš„é€»è¾‘ï¼‰ã€‚
- **æ”¹è¿›è®¡åˆ’**:
  - é‡æ„ `src/router.js`ï¼Œå®Œå…¨ä½¿ç”¨ `vue-router`ã€‚
  - å°†æ‰‹åŠ¨å®ç°çš„è·¯ç”±é€»è¾‘è¿ç§»è‡³æ ‡å‡†çš„è·¯ç”±é…ç½®ã€‚
  - å®ç°æ ‡å‡†çš„å…¨å±€å‰ç½®å®ˆå« (`beforeEach`) æ›¿ä»£æ‰‹åŠ¨ç›‘å¬ã€‚

### 2.2 ç»„ä»¶å¼€å‘æ¨¡å¼è½å (High Severity)

- **ç°çŠ¶**: å¤§é‡è§†å›¾å’Œç»„ä»¶ï¼ˆå¦‚ `src/views/CaseDetail.js`, `src/views/LegalResearch.js`ï¼‰é‡‡ç”¨äº† **Options API + Template String** çš„ `.js` æ–‡ä»¶æ ¼å¼ï¼Œè€Œé Vue 3 æ¨èçš„ **Single File Components (.vue SFC)**ã€‚
- **é—®é¢˜**:
  - ä¸¢å¤±äº† Vue SFC çš„æ ¸å¿ƒä¼˜åŠ¿ï¼šæ¨¡æ¿è¯­æ³•é«˜äº®ã€Scoped CSSã€é¢„ç¼–è¯‘ä¼˜åŒ–ã€‚
  - å¼€å‘ä½“éªŒå·®ï¼Œä»£ç é˜…è¯»å›°éš¾ï¼ˆHTML æ¨¡æ¿ä½œä¸ºå­—ç¬¦ä¸²å†…åµŒåœ¨ JS ä¸­ï¼‰ã€‚
  - éš¾ä»¥åˆ©ç”¨ Vite çš„ HMRï¼ˆçƒ­é‡æ›´æ–°ï¼‰ä¼˜åŠ¿ï¼Œä¸”ä¸æ”¯æŒ `<script setup>` è¯­æ³•ç³–ã€‚
- **æ”¹è¿›è®¡åˆ’**:
  - å°†æ‰€æœ‰ `.js` ç»„ä»¶é‡æ„ä¸º `.vue` æ–‡ä»¶ã€‚
  - ä¼˜å…ˆä½¿ç”¨ `<script setup>` ç»„åˆå¼ APIï¼Œæå‡ä»£ç å¤ç”¨æ€§å’Œç±»å‹æ¨å¯¼èƒ½åŠ›ã€‚
  - æŠ½ç¦»å†…è”æ ·å¼åˆ° `<style scoped>` æˆ– SCSS æ¨¡å—ã€‚

### 2.3 ç›®å½•ç»“æ„æ··ä¹± (Medium Severity)

- **ç°çŠ¶**:
  - `src/views` ç›®å½•ä¸‹å­˜åœ¨æ··åˆçš„æ–‡ä»¶ç±»å‹ï¼ˆ`.vue` å’Œ `.js`ï¼‰ã€‚
  - å­˜åœ¨ `src/views/refactor/` ç›®å½•ï¼Œè¡¨æ˜é‡æ„å·¥ä½œå¤„äºä¸­é—´çŠ¶æ€ä¸”æœªå®Œæˆï¼Œå¯¼è‡´æ–°æ—§ä»£ç å…±å­˜ã€‚
  - `src/views` ç›®å½•æ‰¿æ‹…äº†è¿‡å¤šçš„èŒè´£ï¼Œéƒ¨åˆ†åŠŸèƒ½æ¨¡å—åº”æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ä¸šåŠ¡ç»„ä»¶ã€‚
- **é—®é¢˜**:
  - é¡¹ç›®ç»“æ„ä¸æ¸…æ™°ï¼Œå¢åŠ äº†æ–°æˆå‘˜çš„ä¸Šæ‰‹éš¾åº¦ã€‚
  - "Refactor" ç›®å½•é•¿æœŸå­˜åœ¨ä¼šæˆä¸ºæŠ€æœ¯å€ºåŠ¡çš„æ¸©åºŠã€‚
- **æ”¹è¿›è®¡åˆ’**:
  - ç»Ÿä¸€ç»„ä»¶å­˜æ”¾è§„èŒƒï¼ˆå…¨å‘˜ `.vue` SFCï¼‰ã€‚
  - ç§»é™¤ `refactor` ç›®å½•ï¼Œå°†ç»„ä»¶æ­£å¼å½’ä½åˆ°æ¨¡å—åŒ–ç›®å½•ä¸­ï¼ˆå¦‚ `src/views/Case/`, `src/views/Analysis/`ï¼‰ã€‚

### 2.4 çŠ¶æ€ç®¡ç†ç°ä»£åŒ–ä¸è¶³ (Low Severity)

- **ç°çŠ¶**: ä½¿ç”¨ `src/store/authStore.js` åŸºäº `Vue.reactive` æ‰‹å†™ç®€å•çš„çŠ¶æ€ç®¡ç†ã€‚
- **é—®é¢˜**:
  - ç¼ºä¹ DevTools æ”¯æŒï¼Œéš¾ä»¥è°ƒè¯•çŠ¶æ€å˜åŒ–ã€‚
  - ç›¸æ¯”å®˜æ–¹æ¨èçš„ **Pinia**ï¼Œç¼ºä¹æ’ä»¶ç”Ÿæ€å’Œæ›´å¥½çš„ TypeScript æ”¯æŒï¼ˆè™½ç„¶ç›®å‰æ˜¯ JS é¡¹ç›®ï¼‰ã€‚
- **æ”¹è¿›è®¡åˆ’**:
  - å¼•å…¥ Pinia æ›¿ä»£æ‰‹å†™çš„ Storeã€‚
  - æ¨¡å—åŒ–æ‹†åˆ† Storeï¼ˆUserStore, CaseStore, UIStoreï¼‰ã€‚

### 2.5 å‡æ•°æ®ä¸ç¡¬ç¼–ç  (Medium Severity)

- **ç°çŠ¶**: ~~æ ¸å¿ƒä¸šåŠ¡ç»„ä»¶ï¼ˆå¦‚ `CaseDetail.js`ï¼‰ä¸­åŒ…å«å¤§é‡ç¡¬ç¼–ç çš„ mock æ•°æ®ï¼ˆ`caseData`, `evidenceAnalysis`ï¼‰ï¼Œä¸”ç›´æ¥æ··æ‚åœ¨ç»„ä»¶é€»è¾‘ä¸­ã€‚~~ âœ… **å·²ä¼˜åŒ–**: `CaseDetail.js` å·²ç§»é™¤å¤§é‡ç¡¬ç¼–ç æ•°æ®ï¼ˆ`evidenceAnalysis`, `evidenceFiles`, `stakeholders` ç­‰ï¼‰ï¼Œè¿™äº›åŠŸèƒ½å·²ç”±ç‹¬ç«‹å­æ¨¡å—å¤„ç†ã€‚
- **é—®é¢˜**:
  - ~~å‰åç«¯å¯¹æ¥å›°éš¾ã€‚~~ âœ… **å·²ç¼“è§£**: é‡å¤æ•°æ®å·²ç§»é™¤ï¼Œç»„ä»¶èŒè´£æ›´æ¸…æ™°ã€‚
  - ~~å•å…ƒæµ‹è¯•éš¾ä»¥ç¼–å†™ï¼ˆæ•°æ®è€¦åˆåœ¨ç»„ä»¶å†…éƒ¨ï¼‰ã€‚~~ âœ… **å·²ç¼“è§£**: ä»£ç é‡å‡å°‘ 90%ï¼Œæµ‹è¯•å¤æ‚åº¦é™ä½ã€‚
- **æ”¹è¿›è®¡åˆ’**:
  - âœ… **éƒ¨åˆ†å®Œæˆ**: `CaseDetail.js` å·²ç²¾ç®€ä¸ºè·¯ç”±å¯¼èˆªå…¥å£ï¼Œä»…ä¿ç•™æ ¸å¿ƒçŠ¶æ€å’Œé«˜çº§åŠŸèƒ½ã€‚
  - ğŸ”„ **è¿›è¡Œä¸­**: åˆ›å»ºç‹¬ç«‹çš„ Mock Service æˆ– API Service å±‚ï¼ˆå­æ¨¡å—ä»éœ€å®Œæˆï¼‰ã€‚
  - ğŸ”„ **è¿›è¡Œä¸­**: ç»„ä»¶åº”åªè´Ÿè´£å±•ç¤ºæ•°æ®ï¼Œæ•°æ®è·å–é€»è¾‘æŠ½ç¦»åˆ° `src/services/`ã€‚

## 3. ä¸šåŠ¡åˆ†ç¦»å®æ–½æ–¹æ¡ˆ (Business Separation Implementation)

ä¸ºäº†è§£å†³ "UI ä¸é€»è¾‘è€¦åˆ" åŠ "ä¸šåŠ¡è¾¹ç•Œä¸æ¸…" çš„é—®é¢˜ï¼Œå°†é‡‡å–ä»¥ä¸‹ä¸‰å±‚åˆ†ç¦»ç­–ç•¥ï¼š

### 3.1 ç­–ç•¥ä¸€ï¼šUI ä¸é€»è¾‘åˆ†ç¦» (View vs Logic)

é‡‡ç”¨ Vue 3 **Composition API** å°†ä¸šåŠ¡é€»è¾‘ä»ç»„ä»¶ä¸­æŠ½ç¦»ã€‚

- **å®æ–½å‰**: `CaseDetail.js` (1451 è¡Œï¼ŒåŒ…å« `caseData` å¯¹è±¡ã€`loadCaseData` æ–¹æ³•ã€å¤§é‡ç¡¬ç¼–ç æ•°æ®ã€UI æ¨¡æ¿å­—ç¬¦ä¸²)ã€‚
- **âœ… å·²ä¼˜åŒ–**: `CaseDetail.js` (150 è¡Œï¼Œå·²ç§»é™¤é‡å¤ä»£ç ï¼Œä»…ä¿ç•™è·¯ç”±å¯¼èˆªå’Œé«˜çº§åŠŸèƒ½)ã€‚
- **å®æ–½å**:
  - `src/views/Case/CaseDetail.vue`: ä»…åŒ…å« Template å’Œ UI äº¤äº’é€»è¾‘ï¼ˆå½“å‰ä»£ç å·²ç®€åŒ–ï¼Œè¿ç§»æˆæœ¬é™ä½ï¼‰ã€‚
  - `src/composables/useCaseDetail.js`: åŒ…å« `caseData` å“åº”å¼çŠ¶æ€ã€`loadData` ä¸šåŠ¡æ–¹æ³•ã€‚

**ä»£ç ç¤ºä¾‹**:

```javascript
// composables/useCaseDetail.js
export function useCaseDetail(caseId) {
  const caseData = ref(null)
  const loading = ref(false)

  async function fetchCase() {
    loading.value = true
    caseData.value = await CaseService.getById(caseId)
    loading.value = false
  }

  return { caseData, loading, fetchCase }
}
```

### 3.2 ç­–ç•¥äºŒï¼šé¢†åŸŸé©±åŠ¨ç›®å½•ç»“æ„ (Domain-Driven Structure)

æ‰“ç ´å½“å‰ "æŒ‰æ–‡ä»¶ç±»å‹åˆ†å±‚" (views/components) çš„æ—§æ¨¡å¼ï¼Œè½¬å‘ "æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ†å±‚"ã€‚

**å½“å‰ç»“æ„**:

```
src/
  views/
    CaseList.js
    CaseDetail.js
    LegalResearch.js
  components/
    Sidebar.vue
```

**ç›®æ ‡ç»“æ„** (v2 - ä¼˜åŒ–ç‰ˆ):

```
src/
  # ========== å…±äº«å±‚ (Shared Layer) ==========
  shared/
    components/        # è·¨ feature å…±äº«çš„ UI ç»„ä»¶
      - BaseModal.vue
      - BaseTable.vue
      - LoadingSpinner.vue
    composables/       # é€šç”¨ hooks
      - useLoading.js
      - usePagination.js
    utils/             # çº¯å·¥å…·å‡½æ•° (é Vue å“åº”å¼)
      - formatters.js
      - validators.js
    constants/         # å…¨å±€å¸¸é‡
      - statusCodes.js
      - apiEndpoints.js
    types/             # TypeScript ç±»å‹ (å¯é€‰, ä¸ºæœªæ¥è¿ç§»å‡†å¤‡)
      - index.d.ts

  # ========== å¸ƒå±€å±‚ (Layout Layer) ==========
  layouts/
    - AppLayout.vue    # ä¸»åº”ç”¨å¸ƒå±€
    - AuthLayout.vue   # è®¤è¯é¡µå¸ƒå±€ (ç™»å½•/æ³¨å†Œ)
    components/
      - Sidebar.vue
      - Navbar.vue

  # ========== å…¨å±€çŠ¶æ€ (Global Stores) ==========
  stores/
    - auth.js          # è®¤è¯çŠ¶æ€ (è·¨ feature)
    - ui.js            # UI çŠ¶æ€ (ä¸»é¢˜/ä¾§è¾¹æ æŠ˜å ç­‰)

  # ========== æ ¸å¿ƒæœåŠ¡ (Core Services) ==========
  services/
    - api-client.js    # API åŸºç±»
    - error-handler.js # å…¨å±€é”™è¯¯å¤„ç†

  # ========== ä¸šåŠ¡ç‰¹æ€§ (Features) ==========
  features/
    case/              # æ¡ˆä»¶ç®¡ç† (æ ¸å¿ƒä¸šåŠ¡)
      views/
        - CaseList.vue
        - CaseDetail.vue
        - CaseForm.vue
      modules/         # è¯¦æƒ…é¡µå­æ¨¡å— (Sub-domains)
        basic/
          - BasicInfo.vue
          - useBasicInfo.js
        facts/
          - CaseFacts.vue
          - useCaseFacts.js
        stakeholder/
          - Stakeholders.vue
          - useStakeholders.js
        evidence/
          - Evidence.vue
          - useEvidence.js
        financial/
          - Financial.vue
          - useFinancial.js
        analysis/       # AI åˆ†æ (åŸ refactor/)
          - AIAnalysis.vue
          - AIAssistant.vue
          - RelationshipGraph.vue
          - useAIAnalysis.js
      components/       # æ¡ˆä»¶ä¸“å±ç»„ä»¶
        - CaseCard.vue
        - CaseStatusBadge.vue
      composables/      # æ¡ˆä»¶ä¸šåŠ¡é€»è¾‘
        - useCaseDetail.js
        - useCaseList.js
      services/         # æ¡ˆä»¶ API
        - caseService.js
        - evidenceService.js
      stores/           # æ¡ˆä»¶çŠ¶æ€ (å¯é€‰)
        - caseStore.js

    legal-research/    # æ³•å¾‹æ£€ç´¢
      views/
        - LegalResearch.vue
        - CaseSearchResults.vue
        - RegulationSearchResults.vue
      composables/
        - useLegalSearch.js
      services/
        - searchService.js

    contract/          # åˆåŒå®¡æŸ¥
      views/
        - ContractReview.vue
        - ContractReviewResult.vue
      composables/
        - useContractReview.js
      services/
        - contractService.js

    document/          # æ–‡ä¹¦ç”Ÿæˆ
      views/
        - DocGenerate.vue
      composables/
        - useDocGenerate.js
      services/
        - documentService.js

    auth/              # ç”¨æˆ·è®¤è¯
      views/
        - Login.vue
        - Register.vue
        - ForgotPassword.vue
        - UserProfile.vue
      composables/
        - useAuth.js
      services/
        - authService.js

    system/            # ç³»ç»ŸæœåŠ¡
      views/
        - Settings.vue
        - ProductFeedback.vue
      composables/
        - useSettings.js

  # ========== è·¯ç”±é…ç½® ==========
  router/
    - index.js         # è·¯ç”±ä¸»å…¥å£
    - guards.js        # è·¯ç”±å®ˆå«
    modules/           # æŒ‰ feature æ‹†åˆ†è·¯ç”±
      - case.js
      - auth.js
      - legal-research.js
```

**ç»“æ„è®¾è®¡åŸåˆ™**:
| å±‚çº§ | èŒè´£ | ä¾èµ–æ–¹å‘ |
|------|------|---------|
| `shared/` | é€šç”¨å·¥å…·ï¼Œæ— ä¸šåŠ¡é€»è¾‘ | è¢«æ‰€æœ‰å±‚ä¾èµ– |
| `layouts/` | é¡µé¢å¸ƒå±€æ¡†æ¶ | ä¾èµ– shared |
| `stores/` | å…¨å±€çŠ¶æ€ç®¡ç† | ä¾èµ– shared, services |
| `services/` | API é€šä¿¡åŸºç¡€è®¾æ–½ | ä¾èµ– shared |
| `features/` | ä¸šåŠ¡é€»è¾‘å’Œ UI | ä¾èµ–ä»¥ä¸Šæ‰€æœ‰å±‚ |
| `router/` | è·¯ç”±é…ç½® | ä¾èµ– features, layouts |

> **å•å‘ä¾èµ–åŸåˆ™**: `features/` å¯ä¾èµ– `shared/`ï¼Œä½† `shared/` ä¸èƒ½ä¾èµ– `features/`ã€‚

> **æ¶æ„ä¸€è‡´æ€§è¯´æ˜**:
> è¯¥ç»“æ„ä¸ `docs/æ¶æ„è®¾è®¡æ–‡æ¡£.md` ä¸­ç¬¬ 6 ç«  "æ¨¡å—è®¾è®¡" ç›´æ¥å¯¹åº”ã€‚
>
> - `features/case` å¯¹åº” **6.1 æ¡ˆä»¶ç®¡ç†æ¨¡å—**
> - `features/legal-research` å¯¹åº” **6.2 æ³•å¾‹æ£€ç´¢æ¨¡å—**
> - `features/case/modules/analysis` å¯¹åº” **6.3 é«˜çº§åŠŸèƒ½æ¨¡å—** (ä»ä¸´æ—¶çš„ `refactor/` ç›®å½•æ­£å¼è¿å…¥)

### 3.2.1 DDD é™ç•Œä¸Šä¸‹æ–‡æ˜ å°„ (Bounded Context Mapping)

> å¯¹é½ `docs/æ¶æ„è®¾è®¡æ–‡æ¡£.md` ç¬¬ 17.1 èŠ‚ "é¢†åŸŸé©±åŠ¨è®¾è®¡"ï¼Œå‰ç«¯ features ç›®å½•ä¸åç«¯å¾®æœåŠ¡é¢†åŸŸå¯¹åº”ã€‚

| é™ç•Œä¸Šä¸‹æ–‡ | å‰ç«¯ Feature                               | åç«¯å¾®æœåŠ¡          | æ•°æ®è¡¨                            |
| ---------- | ------------------------------------------ | ------------------- | --------------------------------- |
| **ç”¨æˆ·åŸŸ** | `features/auth/`                           | User Service        | `profiles`, `auth.users`          |
| **æ¡ˆä»¶åŸŸ** | `features/case/`                           | Case Service        | `cases`, `parties`, `contacts`    |
| **æ³•å¾‹åŸŸ** | `features/legal-research/`                 | Search Service      | `search_filter_options`, å¤–éƒ¨ API |
| **æ™ºèƒ½åŸŸ** | `features/case/modules/analysis/`          | AI Service (Python) | - (æ— æŒä¹…åŒ–ï¼Œè°ƒç”¨é€šä¹‰æ³•ç¿)        |
| **æ–‡æ¡£åŸŸ** | `features/document/`, `features/contract/` | Doc Service         | `evidence`, Supabase Storage      |

**å‰ç«¯èŒè´£è¾¹ç•Œ**:

- æ¯ä¸ª `feature` åªèƒ½è°ƒç”¨å¯¹åº”é¢†åŸŸçš„ Service
- è·¨é¢†åŸŸæ•°æ®è·å–å¿…é¡»é€šè¿‡ BFF èšåˆï¼Œç¦æ­¢å‰ç«¯å¤šæ¬¡è¯·æ±‚åæ‹¼æ¥
- `shared/` å±‚ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œä»… UI å·¥å…·

### 3.3 ç­–ç•¥ä¸‰ï¼šæœåŠ¡å±‚æŠ½ç¦» (Service Layer Extraction for BFF)

å»ºç«‹ç»Ÿä¸€çš„ API æœåŠ¡å±‚ï¼Œä¸ä»…ä¸ºäº†è§£è€¦ UIï¼Œæ›´æ˜¯ä¸ºäº†é€‚é…æœªæ¥ **Microservices Phase 1** çš„ BFF ç½‘å…³æ¶æ„ã€‚

- **BFF é€‚é…å±‚**:
  - å½“å‰: å°è£… `Supabase SDK` è°ƒç”¨ã€‚
  - æœªæ¥: æ— ç¼åˆ‡æ¢ä¸º `fetch('/api/v1/...')` è°ƒç”¨ NestJS BFFï¼Œç»„ä»¶å±‚æ— æ„ŸçŸ¥ã€‚
- **åŸºç±»è®¾è®¡ (api-client.js)**:
  - å¿…é¡»åŒ…å« **JWT Token æ³¨å…¥** æ‹¦æˆªå™¨ (å¯¹åº”å¾®æœåŠ¡æ–‡æ¡£ "ç»Ÿä¸€é‰´æƒ" è¦æ±‚)ã€‚
  - å¿…é¡»æ”¯æŒ **SSE (Server-Sent Events)** å¤„ç†èƒ½åŠ›ï¼Œä»¥æ”¯æŒ AI æµå¼è¾“å‡ºã€‚

> **å¾®æœåŠ¡å¯¹é½è¯´æ˜**:
>
> - æ–‡æ¡£å‚è€ƒ: `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` - Phase 1 & Phase 2
> - **é‰´æƒ**: å‰ç«¯ä»…è´Ÿè´£æŒæœ‰ JWTï¼Œç”± `api-client` ç»Ÿä¸€æ³¨å…¥è¯·æ±‚å¤´ã€‚
> - **AI æµå¼**: `features/case/services/ai-service.js` éœ€åŸç”Ÿæ”¯æŒ EventStream è§£æã€‚

### 3.3.1 å‰ç«¯é…åˆå¾®æœåŠ¡æ¼”è¿›è·¯çº¿

> å¯¹é½ `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` ç¬¬ 2-5 èŠ‚ï¼Œå‰ç«¯éœ€é…åˆåç«¯ä¸‰é˜¶æ®µæ¼”è¿›ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å¾®æœåŠ¡é€‚é…è·¯çº¿å›¾                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Phase 1: BFF ç½‘å…³å±‚å¼•å…¥ (å½“å‰é‡ç‚¹)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ä»»åŠ¡:                                                         â”‚  â”‚
â”‚  â”‚ 1. æŠ½è±¡ Service å±‚ï¼Œéš”ç¦» supabase-js è°ƒç”¨                          â”‚  â”‚
â”‚  â”‚ 2. æ‰€æœ‰æ•°æ®è¯·æ±‚é€šè¿‡ api-client.js ç»Ÿä¸€å‡ºå£                          â”‚  â”‚
â”‚  â”‚ 3. é…ç½® BASE_URL ç¯å¢ƒå˜é‡ï¼Œæ”¯æŒåˆ‡æ¢ Supabase â†’ BFF                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â†“                                        â”‚
â”‚  Phase 2: é€»è¾‘ä¸‹æ²‰ (å‰ç«¯è½»é‡åŒ–)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ä»»åŠ¡:                                                         â”‚  â”‚
â”‚  â”‚ 1. ç§»é™¤å‰ç«¯å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚èƒœè¯‰ç‡è®¡ç®—ï¼‰ï¼Œæ”¹è°ƒ BFF æ¥å£                  â”‚  â”‚
â”‚  â”‚ 2. ç§»é™¤ supabase-js ç›´æ¥ SQL æŸ¥è¯¢ï¼Œå…¨éƒ¨èµ° REST API                   â”‚  â”‚
â”‚  â”‚ 3. AI åŠŸèƒ½æ”¹è°ƒ /api/ai/* ç«¯ç‚¹ï¼Œæ”¯æŒ SSE æµå¼                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â†“                                        â”‚
â”‚  Phase 3: é¢†åŸŸå¾®æœåŠ¡æ‹†åˆ† (å‰ç«¯æ— æ„ŸçŸ¥)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ å‰ç«¯ä»»åŠ¡:                                                         â”‚  â”‚
â”‚  â”‚ 1. æ— éœ€æ”¹åŠ¨ï¼BFF å±‚å±è”½åç«¯æ‹†åˆ†ç»†èŠ‚                                  â”‚  â”‚
â”‚  â”‚ 2. (å¯é€‰) å¼•å…¥ GraphQL ç®€åŒ–èšåˆæŸ¥è¯¢                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3.2 è§£è€¦ Supabase ç›´è¿ (å…³é”®å‡†å¤‡)

> **ç›®æ ‡**: å°† `supabase.from('xxx').select()` çš„ç›´æ¥è°ƒç”¨ï¼Œå°è£…åˆ° Service å±‚ï¼Œä¾¿äºæœªæ¥åˆ‡æ¢åˆ° BFFã€‚

**å½“å‰ä»£ç  (å¾…æ”¹é€ )**:

```javascript
// âŒ ç»„ä»¶å†…ç›´æ¥è°ƒç”¨ Supabase
const { data } = await supabase.from('cases').select('*').eq('id', caseId)
```

**ç›®æ ‡ä»£ç  (Service å±‚å°è£…)**:

```javascript
// âœ… ç»„ä»¶åªè°ƒç”¨ Service
const caseData = await caseService.getById(caseId)

// âœ… Service å±‚å°è£…ï¼Œä¾¿äºåˆ‡æ¢
// src/features/case/services/caseService.js
import { apiClient } from '@/services/api-client'

const USE_BFF = import.meta.env.VITE_USE_BFF === 'true'

export const caseService = {
  async getById(id) {
    if (USE_BFF) {
      // Phase 2+: è°ƒç”¨ BFF
      return apiClient.get(`/api/v1/cases/${id}`)
    } else {
      // Phase 1: è°ƒç”¨ Supabase
      const { data, error } = await supabase.from('cases').select('*').eq('id', id).single()
      if (error) throw error
      return data
    }
  }
}
```

**ç¯å¢ƒå˜é‡é…ç½®**:

```bash
# .env.development
VITE_USE_BFF=false
VITE_API_BASE_URL=

# .env.production (åˆ‡æ¢åˆ° BFF å)
VITE_USE_BFF=true
VITE_API_BASE_URL=https://api.legal-workspace.com
```

### 3.4 å®æ–½æ­¥éª¤ (Execution Steps)

å»ºè®®åˆ†é˜¶æ®µè¿›è¡Œè¿ç§»ï¼Œä»¥é™ä½é£é™©ã€‚æ¯ä¸ªé˜¶æ®µåŒ…å«å¯éªŒè¯çš„æ£€æŸ¥ç‚¹ã€‚

---

#### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½å‡†å¤‡ (Phase 1: Infrastructure)

**ç›®æ ‡**: å»ºç«‹æ–°çš„ç›®å½•éª¨æ¶å’Œæ ¸å¿ƒå·¥å…·ç±»ï¼Œä¸æ”¹åŠ¨ç°æœ‰åŠŸèƒ½ä»£ç ã€‚

**æ­¥éª¤ 1.1: åˆ›å»ºç›®å½•ç»“æ„**

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
mkdir -p src/features
mkdir -p src/services
mkdir -p src/composables
mkdir -p src/stores
```

**æ­¥éª¤ 1.2: é…ç½®è·¯å¾„åˆ«å (`vite.config.js`)**

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import { resolve } from 'path'

export default defineConfig({
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
      '@features': resolve(__dirname, 'src/features'),
      '@services': resolve(__dirname, 'src/services'),
      '@composables': resolve(__dirname, 'src/composables'),
      '@stores': resolve(__dirname, 'src/stores')
    }
  }
  // ... å…¶ä»–é…ç½®
})
```

**æ­¥éª¤ 1.3: åˆ›å»º API åŸºç±» (`src/services/api-client.js`)** - **å¢å¼ºç‰ˆ**

```javascript
// src/services/api-client.js
import { supabase } from '@/config/supabase'

/**
 * API å®¢æˆ·ç«¯åŸºç±»
 * - è‡ªåŠ¨æ³¨å…¥ JWT Token
 * - ç»Ÿä¸€é”™è¯¯å¤„ç†
 * - æ”¯æŒè¯·æ±‚å–æ¶ˆ (AbortController)
 * - æ”¯æŒ SSE æµå¼è¯·æ±‚
 */
class ApiClient {
  constructor(baseUrl = '') {
    this.baseUrl = baseUrl
    this.pendingRequests = new Map() // ç”¨äºç®¡ç†å¯å–æ¶ˆçš„è¯·æ±‚
  }

  async getToken() {
    const {
      data: { session }
    } = await supabase.auth.getSession()
    return session?.access_token
  }

  /**
   * é€šç”¨è¯·æ±‚æ–¹æ³•
   * @param {string} endpoint - API ç«¯ç‚¹
   * @param {object} options - fetch é€‰é¡¹
   * @param {string} [options.requestId] - å¯é€‰çš„è¯·æ±‚ IDï¼Œç”¨äºå–æ¶ˆè¯·æ±‚
   */
  async request(endpoint, options = {}) {
    const { requestId, ...fetchOptions } = options

    // å¦‚æœæœ‰ç›¸åŒ requestId çš„è¯·æ±‚æ­£åœ¨è¿›è¡Œï¼Œå…ˆå–æ¶ˆå®ƒ
    if (requestId && this.pendingRequests.has(requestId)) {
      this.pendingRequests.get(requestId).abort()
    }

    const controller = new AbortController()
    if (requestId) {
      this.pendingRequests.set(requestId, controller)
    }

    try {
      const token = await this.getToken()
      const headers = {
        'Content-Type': 'application/json',
        ...(token && { Authorization: `Bearer ${token}` }),
        ...fetchOptions.headers
      }

      const response = await fetch(`${this.baseUrl}${endpoint}`, {
        ...fetchOptions,
        headers,
        signal: controller.signal
      })

      if (!response.ok) {
        const error = await this._parseError(response)
        throw error
      }

      return response.json()
    } catch (error) {
      if (error.name === 'AbortError') {
        console.log(`Request ${requestId} was cancelled`)
        return null
      }
      throw this._handleError(error)
    } finally {
      if (requestId) {
        this.pendingRequests.delete(requestId)
      }
    }
  }

  /**
   * å–æ¶ˆæŒ‡å®šè¯·æ±‚
   */
  cancelRequest(requestId) {
    if (this.pendingRequests.has(requestId)) {
      this.pendingRequests.get(requestId).abort()
      this.pendingRequests.delete(requestId)
    }
  }

  /**
   * SSE æµå¼è¯·æ±‚ (AI å¯¹è¯ç­‰åœºæ™¯)
   */
  async streamRequest(endpoint, options = {}, onChunk, onError) {
    const token = await this.getToken()
    const controller = new AbortController()

    try {
      const response = await fetch(`${this.baseUrl}${endpoint}`, {
        ...options,
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'text/event-stream',
          ...options.headers
        },
        signal: controller.signal
      })

      if (!response.ok) {
        throw await this._parseError(response)
      }

      const reader = response.body.getReader()
      const decoder = new TextDecoder()

      while (true) {
        const { done, value } = await reader.read()
        if (done) break
        const chunk = decoder.decode(value)
        onChunk(chunk)
      }
    } catch (error) {
      if (onError) onError(error)
      throw this._handleError(error)
    }

    // è¿”å›å–æ¶ˆå‡½æ•°
    return () => controller.abort()
  }

  // ========== ç§æœ‰æ–¹æ³• ==========

  async _parseError(response) {
    let message = `HTTP ${response.status}`
    try {
      const body = await response.json()
      message = body.message || body.error || message
    } catch {}

    const error = new Error(message)
    error.status = response.status
    error.isApiError = true
    return error
  }

  _handleError(error) {
    // å¯æ‰©å±•ï¼šä¸ŠæŠ¥é”™è¯¯ã€æ˜¾ç¤º Toast ç­‰
    console.error('[ApiClient Error]', error)
    return error
  }
}

export const apiClient = new ApiClient()
export default ApiClient
```

**æ­¥éª¤ 1.4: åˆ›å»ºå…¨å±€é”™è¯¯å¤„ç† (`src/services/error-handler.js`)**

```javascript
// src/services/error-handler.js
/**
 * å…¨å±€é”™è¯¯å¤„ç†å™¨
 */
export const errorHandler = {
  handle(error, context = '') {
    // æ ¹æ®é”™è¯¯ç±»å‹åˆ†ç±»å¤„ç†
    if (error.isApiError) {
      this._handleApiError(error)
    } else if (error.name === 'ValidationError') {
      this._handleValidationError(error)
    } else {
      this._handleUnknownError(error, context)
    }
  },

  _handleApiError(error) {
    const messages = {
      401: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
      403: 'æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ',
      404: 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
      500: 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
    }
    // TODO: é›†æˆ Toast ç»„ä»¶æ˜¾ç¤ºé”™è¯¯
    console.error(messages[error.status] || error.message)
  },

  _handleValidationError(error) {
    console.error('è¡¨å•éªŒè¯å¤±è´¥:', error.message)
  },

  _handleUnknownError(error, context) {
    console.error(`[${context}] æœªçŸ¥é”™è¯¯:`, error)
  }
}
```

**æ­¥éª¤ 1.5: åˆ›å»º AI Service æµå¼å®¢æˆ·ç«¯ (`src/features/case/services/aiService.js`)**

> å¯¹é½ `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` ç¬¬ 7.1 èŠ‚ "æµå¼å“åº” (SSE/WebSocket)"

```javascript
// src/features/case/services/aiService.js
import { apiClient } from '@/services/api-client'

/**
 * AI æœåŠ¡ - æ”¯æŒæµå¼å“åº”
 * å¯¹æ¥åç«¯ AI Service (FastAPI) çš„ SSE ç«¯ç‚¹
 */
export const aiService = {
  /**
   * æµå¼ç”ŸæˆåˆåŒ/æ–‡ä¹¦
   * @param {Object} request - è¯·æ±‚å‚æ•°
   * @param {Function} onChunk - æ¯ä¸ª chunk çš„å›è°ƒ
   * @param {Function} onComplete - å®Œæˆå›è°ƒ
   * @param {Function} onError - é”™è¯¯å›è°ƒ
   * @returns {Function} å–æ¶ˆå‡½æ•°
   */
  async generateDocument(request, { onChunk, onComplete, onError }) {
    let buffer = ''

    const cancel = await apiClient.streamRequest(
      '/api/ai/generate-document',
      {
        method: 'POST',
        body: JSON.stringify(request)
      },
      chunk => {
        // è§£æ SSE æ ¼å¼: "data: {...}\n\n"
        buffer += chunk
        const lines = buffer.split('\n\n')
        buffer = lines.pop() // ä¿ç•™æœªå®Œæˆçš„éƒ¨åˆ†

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6)
            if (data === '[DONE]') {
              onComplete?.()
            } else {
              try {
                const parsed = JSON.parse(data)
                onChunk?.(parsed)
              } catch (e) {
                // çº¯æ–‡æœ¬ chunk
                onChunk?.({ text: data })
              }
            }
          }
        }
      },
      onError
    )

    return cancel
  },

  /**
   * AI é£é™©åˆ†æ (æµå¼)
   */
  async analyzeRisk(caseId, { onChunk, onComplete, onError }) {
    return this.generateDocument(
      { type: 'risk_analysis', caseId },
      { onChunk, onComplete, onError }
    )
  },

  /**
   * AI å¯¹è¯åŠ©æ‰‹ (æµå¼)
   */
  async chat(caseId, message, { onChunk, onComplete, onError }) {
    return this.generateDocument(
      { type: 'chat', caseId, message },
      { onChunk, onComplete, onError }
    )
  }
}
```

**Vue ç»„ä»¶ä¸­ä½¿ç”¨ç¤ºä¾‹**:

```vue
<script setup>
import { ref, onUnmounted } from 'vue'
import { aiService } from '../services/aiService'

const response = ref('')
const loading = ref(false)
let cancelFn = null

async function startAnalysis() {
  loading.value = true
  response.value = ''

  cancelFn = await aiService.analyzeRisk(caseId, {
    onChunk: chunk => {
      response.value += chunk.text || ''
    },
    onComplete: () => {
      loading.value = false
    },
    onError: error => {
      console.error('AI åˆ†æå¤±è´¥:', error)
      loading.value = false
    }
  })
}

function cancelAnalysis() {
  cancelFn?.()
  loading.value = false
}

onUnmounted(() => cancelFn?.())
</script>
```

**âœ… æ£€æŸ¥ç‚¹**: è¿è¡Œ `npm run dev`ï¼Œç¡®ä¿é¡¹ç›®æ­£å¸¸å¯åŠ¨ï¼Œæ— ç¼–è¯‘é”™è¯¯ã€‚

---

#### ç¬¬äºŒé˜¶æ®µï¼šè¯•ç‚¹è¿ç§» - Auth æ¨¡å— (Phase 2: Pilot)

**ç›®æ ‡**: ä»¥è®¤è¯æ¨¡å—ä¸ºè¯•ç‚¹ï¼ŒéªŒè¯æ–°æ¶æ„æ¨¡å¼çš„å¯è¡Œæ€§ã€‚

**æ­¥éª¤ 2.1: å®‰è£… Pinia**

```bash
npm install pinia
```

**æ­¥éª¤ 2.2: åˆ›å»º Pinia Store (`src/stores/auth.js`)**

```javascript
// src/stores/auth.js
import { defineStore } from 'pinia'
import { supabase } from '@/config/supabase'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,
    session: null,
    loading: true,
    avatarUrl: null,
    title: null
  }),

  getters: {
    isAuthenticated: state => !!state.session
  },

  actions: {
    async initialize() {
      const {
        data: { session }
      } = await supabase.auth.getSession()
      this.session = session
      this.user = session?.user ?? null
      this.loading = false
    },

    async signIn(email, password) {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) throw error
      this.session = data.session
      this.user = data.user
    },

    async signOut() {
      await supabase.auth.signOut()
      this.$reset()
    }
  }
})
```

**æ­¥éª¤ 2.3: åœ¨ `main.js` ä¸­æ³¨å†Œ Pinia**

```javascript
// src/main.js
import { createPinia } from 'pinia'

const pinia = createPinia()
app.use(pinia)
```

**æ­¥éª¤ 2.4: åˆ›å»º Auth ç‰¹æ€§ç›®å½•ç»“æ„**

```bash
mkdir -p src/features/auth/views
mkdir -p src/features/auth/composables
mkdir -p src/features/auth/services
```

**æ­¥éª¤ 2.5: è¿ç§» Login.vue**

- å¤åˆ¶ `src/views/Login.vue` åˆ° `src/features/auth/views/Login.vue`
- æ›´æ–°ç»„ä»¶å†…éƒ¨ï¼Œä½¿ç”¨ `useAuthStore()` æ›¿ä»£æ—§çš„ `authStore` å¼•ç”¨
- æ›´æ–°è·¯ç”±é…ç½®æŒ‡å‘æ–°è·¯å¾„

**âœ… æ£€æŸ¥ç‚¹**: ç™»å½•/ç™»å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

---

#### ç¬¬ä¸‰é˜¶æ®µï¼šæ ¸å¿ƒè¿ç§» - Case æ¨¡å— (Phase 3: Core)

**ç›®æ ‡**: æ‹†åˆ†æœ€å¤æ‚çš„æ¡ˆä»¶ç®¡ç†æ¨¡å—ã€‚

**æ­¥éª¤ 3.1: åˆ›å»º Case ç‰¹æ€§ç›®å½•ç»“æ„**

```bash
mkdir -p src/features/case/views
mkdir -p src/features/case/modules/basic
mkdir -p src/features/case/modules/facts
mkdir -p src/features/case/modules/stakeholder
mkdir -p src/features/case/modules/evidence
mkdir -p src/features/case/modules/financial
mkdir -p src/features/case/modules/analysis
mkdir -p src/features/case/components
mkdir -p src/features/case/composables
mkdir -p src/features/case/services
```

**æ­¥éª¤ 3.2: æŠ½å– Composables**

âœ… **å·²ä¼˜åŒ–**: `CaseDetail.js` å·²ä» 1451 è¡Œç²¾ç®€è‡³ ~150 è¡Œï¼Œç§»é™¤äº†å¤§é‡é‡å¤ä»£ç ï¼ˆè¯æ®ã€å½“äº‹äººã€ç¼–è¾‘åŠŸèƒ½ç­‰ï¼‰ï¼Œè¿™äº›åŠŸèƒ½å·²ç”±ç‹¬ç«‹å­æ¨¡å—ï¼ˆ`CaseEvidence.js`, `CaseStakeholders.js` ç­‰ï¼‰å®ç°ã€‚

ä» `CaseDetail.js` çš„ `data()` å’Œ `methods` ä¸­æŠ½å–é€»è¾‘ï¼ˆå½“å‰ä»£ç å·²ç®€åŒ–ï¼‰ï¼š

```javascript
// src/features/case/composables/useCaseDetail.js
import { ref, onMounted } from 'vue'
import { caseService } from '../services/caseService'

export function useCaseDetail(caseId) {
  const caseData = ref(null)
  const loading = ref(false)
  const error = ref(null)

  async function loadCase() {
    loading.value = true
    try {
      caseData.value = await caseService.getById(caseId)
    } catch (e) {
      error.value = e
    } finally {
      loading.value = false
    }
  }

  onMounted(loadCase)

  return { caseData, loading, error, loadCase }
}
```

**æ­¥éª¤ 3.3: åˆ›å»ºæ¡ˆä»¶æœåŠ¡å±‚**

```javascript
// src/features/case/services/caseService.js
import { supabase } from '@/config/supabase'

export const caseService = {
  async getById(id) {
    const { data, error } = await supabase.from('cases').select('*').eq('id', id).single()
    if (error) throw error
    return data
  },

  async getList(filters = {}) {
    let query = supabase.from('cases').select('*')
    // åº”ç”¨ç­›é€‰æ¡ä»¶...
    const { data, error } = await query
    if (error) throw error
    return data
  }
}
```

**æ­¥éª¤ 3.4: é‡æ„ CaseDetail.vue (SFC)**

ğŸ”„ **è¿›è¡Œä¸­**: `CaseDetail.js` å·²å¤§å¹…ç®€åŒ–ï¼ˆ~150 è¡Œï¼‰ï¼Œä½†ä»ä¸º `.js` æ ¼å¼ã€‚ä¸‹ä¸€æ­¥è½¬æ¢ä¸º Vue SFC:

- Template éƒ¨åˆ†ç§»å…¥ `<template>`
- é€»è¾‘ä½¿ç”¨ `<script setup>` + Composablesï¼ˆå½“å‰é€»è¾‘å·²ç®€åŒ–ï¼Œè¿ç§»æˆæœ¬é™ä½ï¼‰
- æ ·å¼ç§»å…¥ `<style scoped>`

> **æ³¨æ„**: ç”±äºä»£ç å·²ç²¾ç®€ï¼ŒSFC è¿ç§»çš„å·¥ä½œé‡å·²ä»"é«˜"é™è‡³"ä¸­"ã€‚

**æ­¥éª¤ 3.5: æ›´æ–°è·¯ç”±é…ç½®** - **æ¨¡å—åŒ–è·¯ç”± + å®ˆå«**

```javascript
// src/router/index.js
import { createRouter, createWebHashHistory } from 'vue-router'
import { setupGuards } from './guards'

// æ¨¡å—åŒ–è·¯ç”±å¯¼å…¥
import caseRoutes from './modules/case'
import authRoutes from './modules/auth'
import legalResearchRoutes from './modules/legal-research'

const routes = [
  {
    path: '/',
    component: () => import('@/layouts/AppLayout.vue'),
    children: [
      ...caseRoutes,
      ...legalResearchRoutes
      // ... å…¶ä»–ä¸šåŠ¡è·¯ç”±
    ],
    meta: { requiresAuth: true }
  },
  {
    path: '/auth',
    component: () => import('@/layouts/AuthLayout.vue'),
    children: authRoutes
  },
  {
    path: '/:pathMatch(.*)*',
    name: 'NotFound',
    component: () => import('@/shared/components/NotFound.vue')
  }
]

export const router = createRouter({
  history: createWebHashHistory(),
  routes,
  scrollBehavior(to, from, savedPosition) {
    return savedPosition || { top: 0 }
  }
})

// æ³¨å†Œè·¯ç”±å®ˆå«
setupGuards(router)

export default router
```

```javascript
// src/router/guards.js
import { useAuthStore } from '@/stores/auth'

export function setupGuards(router) {
  // å…¨å±€å‰ç½®å®ˆå« - è®¤è¯æ£€æŸ¥
  router.beforeEach(async (to, from, next) => {
    const authStore = useAuthStore()

    // ç¡®ä¿è®¤è¯çŠ¶æ€å·²åˆå§‹åŒ–
    if (authStore.loading) {
      await authStore.initialize()
    }

    const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
    const isAuthPage = to.path.startsWith('/auth')

    if (requiresAuth && !authStore.isAuthenticated) {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      next({ path: '/auth/login', query: { redirect: to.fullPath } })
    } else if (isAuthPage && authStore.isAuthenticated) {
      // å·²ç™»å½•ä½†è®¿é—®è®¤è¯é¡µï¼Œè·³è½¬åˆ°é¦–é¡µ
      next('/')
    } else {
      next()
    }
  })

  // å…¨å±€åç½®å®ˆå« - é¡µé¢æ ‡é¢˜
  router.afterEach(to => {
    document.title = to.meta.title ? `${to.meta.title} - AIæ³•å¾‹åŠ©æ‰‹` : 'AIæ³•å¾‹åŠ©æ‰‹'
  })
}
```

```javascript
// src/router/modules/case.js
export default [
  {
    path: '',
    name: 'CaseList',
    component: () => import('@features/case/views/CaseList.vue'),
    meta: { title: 'æ¡ˆä»¶åˆ—è¡¨' }
  },
  {
    path: 'detail/:id',
    name: 'CaseDetail',
    component: () => import('@features/case/views/CaseDetail.vue'),
    meta: { title: 'æ¡ˆä»¶è¯¦æƒ…' },
    children: [
      { path: 'basic', component: () => import('@features/case/modules/basic/BasicInfo.vue') },
      { path: 'facts', component: () => import('@features/case/modules/facts/CaseFacts.vue') },
      {
        path: 'stakeholders',
        component: () => import('@features/case/modules/stakeholder/Stakeholders.vue')
      },
      { path: 'evidence', component: () => import('@features/case/modules/evidence/Evidence.vue') },
      {
        path: 'financials',
        component: () => import('@features/case/modules/financial/Financial.vue')
      },
      {
        path: 'advanced',
        component: () => import('@features/case/modules/analysis/AIAnalysis.vue')
      }
    ]
  },
  {
    path: 'case/new',
    name: 'CaseCreate',
    component: () => import('@features/case/views/CaseForm.vue'),
    meta: { title: 'æ–°å»ºæ¡ˆä»¶' }
  },
  {
    path: 'case/:id/edit',
    name: 'CaseEdit',
    component: () => import('@features/case/views/CaseForm.vue'),
    meta: { title: 'ç¼–è¾‘æ¡ˆä»¶' }
  }
]
```

**âœ… æ£€æŸ¥ç‚¹**: æ¡ˆä»¶åˆ—è¡¨å’Œè¯¦æƒ…é¡µæ­£å¸¸åŠ è½½ï¼ŒTab åˆ‡æ¢åŠŸèƒ½æ­£å¸¸ï¼Œæœªç™»å½•è‡ªåŠ¨è·³è½¬ç™»å½•é¡µã€‚

---

#### ç¬¬å››é˜¶æ®µï¼šæ¸…ç†ä¸éªŒæ”¶ (Phase 4: Cleanup)

**ç›®æ ‡**: ç§»é™¤æ—§ä»£ç ï¼Œç¡®ä¿é¡¹ç›®æ•´æ´ã€‚

**æ­¥éª¤ 4.1: åˆ é™¤æ—§æ–‡ä»¶**

```bash
# âš ï¸ æ³¨æ„: CaseDetail.js å·²ä¼˜åŒ–ï¼ˆ~150 è¡Œï¼‰ï¼Œæš‚ä¸åˆ é™¤ï¼Œå¾… SFC è¿ç§»ååˆ é™¤
# åˆ é™¤å·²è¿ç§»çš„æ—§ JS æ–‡ä»¶
# rm src/views/CaseDetail.js  # å¾… SFC è¿ç§»ååˆ é™¤
rm src/views/CaseList.js
# ... å…¶ä»–å·²è¿ç§»æ–‡ä»¶

# åˆ é™¤ refactor ç›®å½•ï¼ˆrefactor/ ä¸‹çš„ç»„ä»¶å·²æ•´åˆåˆ°ç‹¬ç«‹æ¨¡å—ï¼‰
rm -rf src/views/refactor
```

**æ­¥éª¤ 4.2: æ›´æ–°å¯¼å…¥è·¯å¾„**

- å…¨å±€æœç´¢ `from '../views/'` æˆ– `from '@/views/'`
- æ›¿æ¢ä¸ºå¯¹åº”çš„ `@features/` è·¯å¾„

**æ­¥éª¤ 4.3: è¿è¡Œæµ‹è¯•**

```bash
npm run test
npm run lint
```

**æ­¥éª¤ 4.4: æ„å»ºéªŒè¯**

```bash
npm run build
npm run preview
```

**âœ… æœ€ç»ˆæ£€æŸ¥ç‚¹**:

- [ ] æ—  ESLint é”™è¯¯
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ç”Ÿäº§æ„å»ºæˆåŠŸ
- [ ] æ ¸å¿ƒç”¨æˆ·æµç¨‹ï¼ˆç™»å½• â†’ æ¡ˆä»¶åˆ—è¡¨ â†’ æ¡ˆä»¶è¯¦æƒ…ï¼‰åŠŸèƒ½æ­£å¸¸

## 3.5 å‰ç«¯æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 3.5.1 è§£å†³ N+1 é—®é¢˜ (DataLoader æ¨¡å¼)

> å¯¹é½ `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` ç¬¬ 4.4 èŠ‚ "BFF å±‚ N+1 é—®é¢˜è§£å†³"

**é—®é¢˜åœºæ™¯**: æ¡ˆä»¶åˆ—è¡¨é¡µéœ€è¦æ˜¾ç¤ºæ¯ä¸ªæ¡ˆä»¶çš„è´Ÿè´£å¾‹å¸ˆå¤´åƒï¼Œå¦‚æœå¾ªç¯è¯·æ±‚ä¼šäº§ç”Ÿ N+1 é—®é¢˜ã€‚

**å‰ç«¯é…åˆæ–¹æ¡ˆ**:

```javascript
// src/shared/utils/batchLoader.js
/**
 * å‰ç«¯æ‰¹é‡åŠ è½½å™¨ (é…åˆ BFF DataLoader)
 * æ”¶é›†çŸ­æ—¶é—´å†…çš„è¯·æ±‚ï¼Œåˆå¹¶ä¸ºä¸€æ¬¡æ‰¹é‡è¯·æ±‚
 */
export function createBatchLoader(batchFn, options = {}) {
  const { delay = 10, maxBatchSize = 100 } = options
  let queue = []
  let timeoutId = null

  async function flush() {
    const batch = queue
    queue = []
    timeoutId = null

    if (batch.length === 0) return

    const ids = batch.map(item => item.id)
    const results = await batchFn(ids)

    batch.forEach((item, index) => {
      item.resolve(results[index])
    })
  }

  return {
    load(id) {
      return new Promise((resolve, reject) => {
        queue.push({ id, resolve, reject })

        if (queue.length >= maxBatchSize) {
          clearTimeout(timeoutId)
          flush()
        } else if (!timeoutId) {
          timeoutId = setTimeout(flush, delay)
        }
      })
    }
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**:

```javascript
// src/features/auth/services/userService.js
import { createBatchLoader } from '@/shared/utils/batchLoader'
import { apiClient } from '@/services/api-client'

// åˆ›å»ºç”¨æˆ·æ‰¹é‡åŠ è½½å™¨
const userLoader = createBatchLoader(async userIds => {
  // å•æ¬¡æ‰¹é‡è¯·æ±‚ï¼Œè€Œé N æ¬¡å•ç‹¬è¯·æ±‚
  const users = await apiClient.post('/api/v1/users/batch', { ids: userIds })
  // æŒ‰ ID é¡ºåºè¿”å›ç»“æœ
  return userIds.map(id => users.find(u => u.id === id) || null)
})

export const userService = {
  // å•ä¸ªè·å– (è‡ªåŠ¨æ‰¹é‡åŒ–)
  async getById(userId) {
    return userLoader.load(userId)
  },

  // ç›´æ¥æ‰¹é‡è·å–
  async batchGetByIds(userIds) {
    return Promise.all(userIds.map(id => userLoader.load(id)))
  }
}
```

### 3.5.2 è¯·æ±‚å»é‡ä¸ç¼“å­˜

```javascript
// src/services/api-client.js å¢å¼º
class ApiClient {
  constructor() {
    // ...existing code...
    this.requestCache = new Map() // è¯·æ±‚ç¼“å­˜
    this.cacheExpiry = 5 * 60 * 1000 // 5 åˆ†é’Ÿè¿‡æœŸ
  }

  /**
   * å¸¦ç¼“å­˜çš„ GET è¯·æ±‚
   */
  async cachedGet(endpoint, options = {}) {
    const cacheKey = `${endpoint}:${JSON.stringify(options)}`
    const cached = this.requestCache.get(cacheKey)

    if (cached && Date.now() - cached.timestamp < this.cacheExpiry) {
      return cached.data
    }

    const data = await this.request(endpoint, { ...options, method: 'GET' })
    this.requestCache.set(cacheKey, { data, timestamp: Date.now() })
    return data
  }

  /**
   * æ¸…é™¤ç¼“å­˜ (å†™æ“ä½œåè°ƒç”¨)
   */
  invalidateCache(pattern) {
    for (const key of this.requestCache.keys()) {
      if (key.includes(pattern)) {
        this.requestCache.delete(key)
      }
    }
  }
}
```

## 4. æµ‹è¯•ç­–ç•¥ (Testing Strategy)

### 4.1 æµ‹è¯•æ–‡ä»¶ç»„ç»‡

```
src/
  features/
    case/
      views/
        - CaseList.vue
        - CaseList.spec.js      # ç»„ä»¶æµ‹è¯• (ä¸ç»„ä»¶åŒç›®å½•)
      composables/
        - useCaseDetail.js
        - useCaseDetail.spec.js # Composable æµ‹è¯•
      services/
        - caseService.js
        - caseService.spec.js   # Service æµ‹è¯•

tests/
  e2e/                          # ç«¯åˆ°ç«¯æµ‹è¯•
    - case-flow.spec.js         # æ¡ˆä»¶ç®¡ç†æµç¨‹
    - auth-flow.spec.js         # ç™»å½•æµç¨‹
  integration/                  # é›†æˆæµ‹è¯•
    - api-client.spec.js
```

### 4.2 æµ‹è¯•ç±»å‹ä¸è¦†ç›–ç›®æ ‡

| æµ‹è¯•ç±»å‹     | å·¥å…·                    | è¦†ç›–ç›®æ ‡                     | ä¼˜å…ˆçº§ |
| ------------ | ----------------------- | ---------------------------- | ------ |
| **å•å…ƒæµ‹è¯•** | Vitest                  | Composables, Services, Utils | P0     |
| **ç»„ä»¶æµ‹è¯•** | Vitest + Vue Test Utils | æ ¸å¿ƒç»„ä»¶äº¤äº’                 | P1     |
| **E2E æµ‹è¯•** | Playwright / Cypress    | å…³é”®ç”¨æˆ·æµç¨‹                 | P2     |

### 4.3 æµ‹è¯•ç¤ºä¾‹

```javascript
// src/features/case/composables/useCaseDetail.spec.js
import { describe, it, expect, vi } from 'vitest'
import { useCaseDetail } from './useCaseDetail'
import { caseService } from '../services/caseService'

vi.mock('../services/caseService')

describe('useCaseDetail', () => {
  it('should load case data on mount', async () => {
    const mockCase = { id: '1', name: 'Test Case' }
    caseService.getById.mockResolvedValue(mockCase)

    const { caseData, loadCase } = useCaseDetail('1')
    await loadCase()

    expect(caseData.value).toEqual(mockCase)
  })

  it('should handle loading state', async () => {
    const { loading, loadCase } = useCaseDetail('1')

    expect(loading.value).toBe(false)
    const promise = loadCase()
    expect(loading.value).toBe(true)
    await promise
    expect(loading.value).toBe(false)
  })
})
```

## 5. å›æ»šæ–¹æ¡ˆ (Rollback Plan)

### 5.1 åˆ†æ”¯ç­–ç•¥

```
main (ç¨³å®šç‰ˆ)
  â””â”€â”€ feature/architecture-refactor (é‡æ„åˆ†æ”¯)
        â”œâ”€â”€ phase-1-infrastructure
        â”œâ”€â”€ phase-2-auth
        â”œâ”€â”€ phase-3-case
        â””â”€â”€ phase-4-cleanup
```

### 5.2 æ£€æŸ¥ç‚¹ä¸å›æ»š

| é˜¶æ®µ    | æ£€æŸ¥ç‚¹                 | å›æ»šæ“ä½œ                |
| ------- | ---------------------- | ----------------------- |
| Phase 1 | `npm run dev` æ­£å¸¸å¯åŠ¨ | `git checkout main`     |
| Phase 2 | ç™»å½•/ç™»å‡ºåŠŸèƒ½æ­£å¸¸      | `git revert` åˆ° phase-1 |
| Phase 3 | æ¡ˆä»¶åˆ—è¡¨/è¯¦æƒ…æ­£å¸¸      | `git revert` åˆ° phase-2 |
| Phase 4 | å…¨éƒ¨æµ‹è¯•é€šè¿‡           | `git revert` åˆ° phase-3 |

### 5.3 ç´§æ€¥å›æ»šå‘½ä»¤

```bash
# å¦‚æœé‡æ„åˆ†æ”¯å‡ºç°ä¸¥é‡é—®é¢˜ï¼Œç«‹å³å›æ»šåˆ° main
git checkout main
npm install
npm run dev

# å¦‚æœå·²åˆå¹¶åˆ° mainï¼Œå›é€€åˆ°ä¸Šä¸€ä¸ªç¨³å®š tag
git checkout v3.10  # å½“å‰ç¨³å®šç‰ˆæœ¬
```

## 6. æ”¹è¿›è·¯çº¿å›¾

### 6.1 å‰ç«¯æ¶æ„ä¼˜åŒ– (å½“å‰é˜¶æ®µ)

| ä¼˜å…ˆçº§ | ä»»åŠ¡                                                             | é¢„è®¡è€—æ—¶      | é£é™©                              | çŠ¶æ€      |
| :----- | :--------------------------------------------------------------- | :------------ | :-------------------------------- | :-------- |
| **P0** | **é‡æ„è·¯ç”±ç³»ç»Ÿ**: åˆ‡æ¢è‡³ `vue-router`ï¼Œå®ç°æ¨¡å—åŒ–è·¯ç”± + å®ˆå«     | 1.5 å¤©        | ä¸­                                | ğŸ”„ å¾…å¼€å§‹ |
| **P0** | **ç»„ä»¶ SFC åŒ–**: `.js` -> `.vue` (CaseDetail ç­‰æ ¸å¿ƒé¡µé¢)         | **1-2 å¤©**    | **ä¸­**ï¼ˆâœ… å·²ç²¾ç®€ï¼Œè¿ç§»æˆæœ¬é™ä½ï¼‰ | ğŸ”„ è¿›è¡Œä¸­ |
| **P1** | **ä»£ç ä¼˜åŒ–**: ç§»é™¤é‡å¤ä»£ç ï¼ˆâœ… CaseDetail.js å·²å®Œæˆï¼‰            | âœ… **å·²å®Œæˆ** | -                                 | âœ… å·²å®Œæˆ |
| **P1** | **ç›®å½•ç»“æ„è¿ç§»**: å»ºç«‹ `shared/` + `layouts/` + `features/` ç»“æ„ | 1 å¤©          | ä½                                | ğŸ”„ å¾…å¼€å§‹ |
| **P1** | **API å±‚å¢å¼º**: é”™è¯¯å¤„ç†ã€è¯·æ±‚å–æ¶ˆã€ç¼“å­˜ã€BatchLoader            | 1.5 å¤©        | ä½                                | ğŸ”„ å¾…å¼€å§‹ |
| **P1** | **Service å±‚å°è£…**: æŠ½ç¦» Supabase è°ƒç”¨ï¼Œæ”¯æŒç¯å¢ƒå˜é‡åˆ‡æ¢         | 2 å¤©          | ä½                                | ğŸ”„ è¿›è¡Œä¸­ |
| **P2** | **å¼•å…¥ Pinia**: æ›¿æ¢ `authStore`ï¼Œæ¨¡å—åŒ–æ‹†åˆ†                     | 1 å¤©          | ä½                                | ğŸ”„ å¾…å¼€å§‹ |
| **P2** | **æµ‹è¯•è¦†ç›–**: Composables + Services å•å…ƒæµ‹è¯•                    | 2 å¤©          | ä½                                | ğŸ”„ å¾…å¼€å§‹ |

### 6.2 å¾®æœåŠ¡é…åˆå‡†å¤‡ (Phase 1 å¯¹é½)

> å¯¹é½ `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` Phase 1: BFF ç½‘å…³å±‚å¼•å…¥

| ä¼˜å…ˆçº§ | ä»»åŠ¡                                                   | é¢„è®¡è€—æ—¶ | ä¾èµ–       | çŠ¶æ€      |
| :----- | :----------------------------------------------------- | :------- | :--------- | :-------- |
| **P0** | **API Client åŸºç±»**: æ”¯æŒ JWT æ³¨å…¥ã€SSE æµå¼ã€è¯·æ±‚å–æ¶ˆ | 1 å¤©     | -          | ğŸ”„ å¾…å¼€å§‹ |
| **P0** | **AI Service å®¢æˆ·ç«¯**: å®ç° SSE æµå¼è§£æï¼Œæ”¯æŒå–æ¶ˆ     | 0.5 å¤©   | API Client | ğŸ”„ å¾…å¼€å§‹ |
| **P1** | **ç¯å¢ƒå˜é‡é…ç½®**: `VITE_USE_BFF`, `VITE_API_BASE_URL`  | 0.5 å¤©   | -          | ğŸ”„ å¾…å¼€å§‹ |
| **P1** | **Service å±‚åŒæ¨¡å¼**: æ”¯æŒ Supabase / BFF åˆ‡æ¢         | 2 å¤©     | ç¯å¢ƒå˜é‡   | ğŸ”„ å¾…å¼€å§‹ |
| **P2** | **BatchLoader å®ç°**: è§£å†³ N+1 é—®é¢˜                    | 1 å¤©     | Service å±‚ | ğŸ”„ å¾…å¼€å§‹ |

### 6.3 å¾®æœåŠ¡é…åˆå‡†å¤‡ (Phase 2 é¢„å¤‡)

> å¯¹é½ `docs/å¾®æœåŠ¡æ²»ç†æ–‡æ¡£.md` Phase 2: ä¸šåŠ¡é€»è¾‘ä¸‹æ²‰

| ä¼˜å…ˆçº§ | ä»»åŠ¡                                            | é¢„è®¡è€—æ—¶ | ä¾èµ–           | çŠ¶æ€      |
| :----- | :---------------------------------------------- | :------- | :------------- | :-------- |
| **P2** | **ç§»é™¤å‰ç«¯å¤æ‚é€»è¾‘**: èƒœè¯‰ç‡è®¡ç®—ç­‰ç§»è‡³åç«¯      | 1 å¤©     | BFF ä¸Šçº¿       | ğŸ“… å¾…åç«¯ |
| **P2** | **ç§»é™¤ Supabase ç›´è¿**: å…¨éƒ¨åˆ‡æ¢åˆ° BFF API      | 1 å¤©     | Service åŒæ¨¡å¼ | ğŸ“… å¾…åç«¯ |
| **P3** | **GraphQL è¯„ä¼°**: è¯„ä¼°æ˜¯å¦å¼•å…¥ GraphQL ç®€åŒ–èšåˆ | 0.5 å¤©   | Phase 2 å®Œæˆ   | ğŸ“… å¾…è¯„ä¼° |

### 6.4 é‡Œç¨‹ç¢‘ä¸æ£€æŸ¥ç‚¹

| é‡Œç¨‹ç¢‘             | å®Œæˆæ ‡å‡†                           | ç›®æ ‡æ—¥æœŸ       |
| :----------------- | :--------------------------------- | :------------- |
| **M1: æ¶æ„ç°ä»£åŒ–** | vue-router + SFC + ç›®å½•è¿ç§»å®Œæˆ    | +2 å‘¨          |
| **M2: BFF Ready**  | Service å±‚å°è£…å®Œæˆï¼Œæ”¯æŒåŒæ¨¡å¼åˆ‡æ¢ | +4 å‘¨          |
| **M3: å¾®æœåŠ¡å¯¹æ¥** | åˆ‡æ¢åˆ° BFFï¼Œç§»é™¤ Supabase ç›´è¿     | å¾…åç«¯ Phase 1 |

## 7. ç»“è®º

### 7.1 æœ¬æ¬¡æ–‡æ¡£æ›´æ–°æ€»ç»“ (v2.1)

| æ”¹è¿›é¡¹          | å˜æ›´è¯´æ˜                                                        |
| --------------- | --------------------------------------------------------------- |
| **ç›®å½•ç»“æ„**    | æ–°å¢ `shared/`, `layouts/`, `router/` å±‚ï¼Œå®Œå–„ feature å†…éƒ¨ç»“æ„ |
| **DDD å¯¹é½**    | features ç›®å½•ä¸åç«¯å¾®æœåŠ¡é™ç•Œä¸Šä¸‹æ–‡å¯¹åº”                         |
| **API Client**  | å¢å¼ºç‰ˆè®¾è®¡ï¼šæ”¯æŒè¯·æ±‚å–æ¶ˆã€ç»Ÿä¸€é”™è¯¯å¤„ç†ã€SSE æµå¼ã€ç¼“å­˜          |
| **AI Service**  | æ–°å¢æµå¼å“åº”å®¢æˆ·ç«¯ï¼Œæ”¯æŒ SSE è§£æå’Œå–æ¶ˆ                         |
| **BatchLoader** | æ–°å¢æ‰¹é‡åŠ è½½å™¨ï¼Œè§£å†³ N+1 é—®é¢˜                                   |
| **å¾®æœåŠ¡é€‚é…**  | Service å±‚åŒæ¨¡å¼è®¾è®¡ï¼Œæ”¯æŒ Supabase / BFF åˆ‡æ¢                  |
| **è·¯ç”±ç³»ç»Ÿ**    | æ·»åŠ æ¨¡å—åŒ–è·¯ç”±é…ç½® + å®ˆå«å®ç°æ–¹æ¡ˆ                               |
| **æµ‹è¯•ç­–ç•¥**    | æ–°å¢æµ‹è¯•æ–‡ä»¶ç»„ç»‡ã€ç±»å‹è¦†ç›–ã€ç¤ºä¾‹ä»£ç                             |
| **å›æ»šæ–¹æ¡ˆ**    | æ–°å¢åˆ†æ”¯ç­–ç•¥ã€æ£€æŸ¥ç‚¹ã€ç´§æ€¥å›æ»šå‘½ä»¤                              |

### 7.2 ä¸å¾®æœåŠ¡æ²»ç†æ–‡æ¡£å¯¹é½æƒ…å†µ

| å¾®æœåŠ¡æ–‡æ¡£ç« èŠ‚       | å‰ç«¯é…åˆçŠ¶æ€ | è¯´æ˜                                   |
| -------------------- | ------------ | -------------------------------------- |
| **3.2 è¯·æ±‚é“¾è·¯è®¾è®¡** | âœ… å·²è§„åˆ’    | API Client æ”¯æŒ JWT æ³¨å…¥               |
| **3.3 ç»Ÿä¸€é‰´æƒ**     | âœ… å·²è§„åˆ’    | å‰ç«¯ä»…æŒæœ‰ JWTï¼Œç”± api-client ç»Ÿä¸€æ³¨å…¥ |
| **4.4 N+1 é—®é¢˜**     | âœ… å·²è§„åˆ’    | BatchLoader å®ç°æ–¹æ¡ˆ                   |
| **7.1 æµå¼å“åº”**     | âœ… å·²è§„åˆ’    | aiService SSE å®¢æˆ·ç«¯                   |
| **Phase 1 BFF**      | âœ… å·²è§„åˆ’    | Service å±‚åŒæ¨¡å¼åˆ‡æ¢                   |
| **Phase 2 é€»è¾‘ä¸‹æ²‰** | ğŸ“… å¾…åç«¯    | ç§»é™¤å‰ç«¯å¤æ‚é€»è¾‘                       |

### 7.3 æ¶æ„è¯„ä¼°

å½“å‰æ¶æ„å¤„äº **"è¿‡æ¸¡æ€"**ï¼Œæ··æ‚äº†æ—§å¼ Vue å†™æ³•å’Œç°ä»£æ„å»ºå·¥å…·ï¼ˆViteï¼‰ã€‚æœ¬æ¬¡ä¼˜åŒ–åï¼š

- âœ… **CaseDetail.js å·²ç²¾ç®€ 90%**ï¼Œä¸ºåç»­ SFC è¿ç§»é™ä½æˆæœ¬
- âœ… **ç›®æ ‡ç»“æ„å·²å®Œå–„**ï¼Œç¬¦åˆ Feature-Based + åˆ†å±‚æ¶æ„æ ‡å‡†
- âœ… **å¾®æœåŠ¡é€‚é…å·²è§„åˆ’**ï¼ŒService å±‚æ”¯æŒåŒæ¨¡å¼ï¼Œä¾¿äº BFF å¯¹æ¥
- âœ… **AI æµå¼å·²è§„åˆ’**ï¼Œæ”¯æŒ SSE è§£æå’Œå–æ¶ˆ
- âœ… **å®æ–½è·¯å¾„å·²æ˜ç¡®**ï¼ŒåŒ…å«æ£€æŸ¥ç‚¹å’Œå›æ»šæ–¹æ¡ˆ

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:

1. ç«‹å³å¯åŠ¨ **P0 çº§** ä»»åŠ¡ï¼ˆè·¯ç”±é‡æ„ + SFC è¿ç§»ï¼‰
2. å¹¶è¡Œå®Œæˆ **API Client å¢å¼º**ï¼Œä¸º BFF å¯¹æ¥åšå‡†å¤‡
3. å¾…åç«¯ Phase 1 ä¸Šçº¿åï¼Œåˆ‡æ¢ Service å±‚åˆ° BFF æ¨¡å¼
