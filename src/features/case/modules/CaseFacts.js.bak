import CaseModuleLayout from '@/components/case/CaseModuleLayout.js';

/**
 * 案情描述模块
 */
export default {
    name: 'CaseFacts',
    components: {
        CaseModuleLayout
    },
    data() {
        return {
            caseId: '',
            caseData: {},
            factsData: {
                description: '2023年3月，原告张某与被告某科技有限公司签订软件开发合同，约定开发费用100万元。项目于2023年9月完成并交付，被告已支付50万元，剩余50万元尾款迟迟未支付。多次催款无果后，原告诉至法院。',
                disputeFocus: ['软件是否已实际交付', '质量验收是否合格', '违约损失金额'],
                objective: '支付剩余款项50万元 + 违约金8万元 + 利息'
            },
            showCaseFactsModal: false,
            editForm: {}
        };
    },
    created() {
        const hash = window.location.hash;
        const match = hash.match(/\/detail\/([^/]+)/);
        this.caseId = match ? match[1] : '1';
    },
    methods: {
        onCaseLoaded(data) {
            this.caseData = data;
        },
        editCaseFacts() {
            this.editForm = {
                description: this.factsData.description,
                disputeFocus: this.factsData.disputeFocus.join(', '),
                objective: this.factsData.objective
            };
            this.showCaseFactsModal = true;
        },
        saveCaseFacts() {
            this.factsData.description = this.editForm.description;
            this.factsData.disputeFocus = this.editForm.disputeFocus.split(',').map(s => s.trim());
            this.factsData.objective = this.editForm.objective;
            this.showCaseFactsModal = false;
            alert('案情描述已更新');
        }
    },
    template: `
        <CaseModuleLayout :case-id="caseId" active-module="facts" @case-loaded="onCaseLoaded">
            <div class="tab-pane">
                <div class="modern-card">
                    <div class="card-header" style="background: transparent;">
                        <div class="card-title">案情描述</div>
                        <button class="icon-btn" style="font-size: 14px;" @click="editCaseFacts">
                            <i class="fas fa-pen"></i>
                        </button>
                    </div>
                    <div class="info-row" style="display: block;">
                        <span class="label" style="marginBottom: 8px;">案情摘要</span>
                        <p style="margin: 8px 0 0 0; color: #1a1a1a; line-height: 1.8; font-size: 14px;">
                            {{ factsData.description }}
                        </p>
                    </div>
                    <div class="info-row" style="display: block; margin-top: 16px;">
                        <span class="label">争议焦点</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            <span 
                                v-for="(focus, index) in factsData.disputeFocus" 
                                :key="index"
                                class="tag" 
                                style="background: #e0e7ff; color: #4f46e5; padding: 6px 12px; border-radius: 6px; font-size: 13px;"
                            >
                                {{ focus }}
                            </span>
                        </div>
                    </div>
                    <div class="info-row" style="margin-top: 16px;">
                        <span class="label">客户诉求</span>
                        <span class="value">{{ factsData.objective }}</span>
                    </div>
                </div>
            </div>

            <!-- Case Facts Edit Modal -->
            <div v-if="showCaseFactsModal" class="modal-overlay" @click.self="showCaseFactsModal = false">
                <div class="modal-container" style="width: 700px;">
                    <div class="modal-header">
                        <div class="modal-title">编辑案情描述</div>
                        <button class="modal-close" @click="showCaseFactsModal = false">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="smart-form-group">
                            <label class="smart-label">案情摘要</label>
                            <textarea class="smart-textarea" v-model="editForm.description" rows="6" placeholder="请详细描述案件的基本情况" style="border: 1px solid #ccc;"></textarea>
                        </div>
                        <div class="smart-form-group">
                            <label class="smart-label">争议焦点</label>
                            <textarea class="smart-textarea" v-model="editForm.disputeFocus" rows="4" placeholder="请输入案件的主要争议焦点，多个用逗号分隔" style="border: 1px solid #ccc;"></textarea>
                        </div>
                        <div class="smart-form-group">
                            <label class="smart-label">客户诉求</label>
                            <textarea class="smart-textarea" v-model="editForm.objective" rows="3" placeholder="请输入客户的诉讼目标和诉求" style="border: 1px solid #ccc;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="smart-btn-secondary" @click="showCaseFactsModal = false">取消</button>
                        <button class="smart-btn-primary" @click="saveCaseFacts"><i class="fas fa-save"></i> 保存</button>
                    </div>
                </div>
            </div>
        </CaseModuleLayout>
    `
};
